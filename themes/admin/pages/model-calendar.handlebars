<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0"><i class="fas fa-calendar me-2"></i>Calendar Management — {{model.name}}</h3>
  <a class="btn btn-outline-secondary" href="/{{model.slug}}/admin"><i class="fas fa-arrow-left me-2"></i>Back to Dashboard</a>
</div>

<div class="card mb-3">
  <div class="card-header bg-white"><strong>Add Location/Vacation Period</strong></div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" class="form-control" id="cal_start">
      </div>
      <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" class="form-control" id="cal_end">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="cal_all_day" checked>
          <label class="form-check-label" for="cal_all_day">All Day</label>
        </div>
      </div>
      <div class="col-md-4">
        <label class="form-label">Location</label>
        <input class="form-control" id="cal_location" placeholder="e.g., Denver, Austin, Vacation">
      </div>
      <div class="col-md-3">
        <label class="form-label">Availability Status</label>
        <select class="form-select" id="cal_status">
          <option value="available">Available for Appointments</option>
          <option value="unavailable">Unavailable</option>
          <option value="travel">Travel</option>
          <option value="vacation">Vacation</option>
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Calendar Display Color</label>
        <input type="color" class="form-control form-control-color" id="cal_color" value="#22c55e">
      </div>
      <div class="col-md-6">
        <label class="form-label">Internal Notes</label>
        <input class="form-control" id="cal_notes" placeholder="Internal notes for planning only">
      </div>
      <div class="col-12">
        <button class="btn btn-primary" id="cal_add">Add Calendar Period</button>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header bg-white"><strong>Current & Upcoming Availability</strong></div>
  <div class="card-body" id="cal_list"><div class="text-muted">Loading…</div></div>
</div>

<script>
(function(){
  let slug = {{{json model.slug}}}; if (!slug){ const m=location.pathname.match(/^\/([^\/]+)\/admin/); if(m) slug=m[1]; }
  const list = document.getElementById('cal_list');

  async function load(){
    const r = await fetch(`/api/model-calendar/${encodeURIComponent(slug)}`);
    const d = await r.json();
    if (!d.success){ list.innerHTML = '<div class="text-danger">Failed to load</div>'; return; }
    const items = (d.data.periods || []).sort((a,b)=> new Date(a.start_date) - new Date(b.start_date));
    if (!items.length){ list.innerHTML = '<div class="text-muted">No calendar periods yet.</div>'; return; }
    list.innerHTML = items.map(it => `
      <div class=\"border rounded p-2 mb-2\" style=\"border-left: 6px solid ${it.color || '#22c55e'}\">
        <div class=\"d-flex align-items-center justify-content-between\">
          <div>
            <strong>${it.location || '—'}</strong>
            <span class=\"badge ms-2 ${it.status==='available'?'bg-success':(it.status==='unavailable'?'bg-secondary':(it.status==='travel'?'bg-info':'bg-warning text-dark'))}\">${it.status}</span>
          </div>
          <div class=\"text-muted small\">${it.start_date} → ${it.end_date} ${it.all_day? '(all day)':''}</div>
        </div>
        ${it.notes ? `<div class=\"small text-muted mt-1\">${it.notes.replace(/</g,'&lt;')}</div>`:''}
        <div class=\"mt-2\">
          <button class=\"btn btn-sm btn-outline-danger btn-del\" data-id=\"${it.id}\">Delete</button>
        </div>
      </div>`).join('');
    list.querySelectorAll('.btn-del').forEach(b=>b.addEventListener('click', async ()=>{
      if (!confirm('Delete this period?')) return; const id=b.getAttribute('data-id');
      const r = await fetch(`/api/model-calendar/${encodeURIComponent(slug)}/${id}`, { method:'DELETE' }); const d = await r.json();
      if (!d.success){ notify('danger', d.message||'Delete failed'); return; } notify('success','Deleted'); load();
    }));
  }

  document.getElementById('cal_add').addEventListener('click', async ()=>{
    const body = {
      start_date: document.getElementById('cal_start').value,
      end_date: document.getElementById('cal_end').value,
      all_day: document.getElementById('cal_all_day').checked,
      location: document.getElementById('cal_location').value.trim(),
      status: document.getElementById('cal_status').value,
      color: document.getElementById('cal_color').value,
      notes: document.getElementById('cal_notes').value.trim()
    };
    if (!body.start_date || !body.end_date){ notify('warning','Choose start/end dates'); return; }
    const r = await fetch(`/api/model-calendar/${encodeURIComponent(slug)}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
    const d = await r.json(); if (!d.success){ notify('danger', d.message||'Add failed'); return; }
    notify('success','Added'); load();
  });

  load();
})();
</script>


