<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Admin Queue Review & Gaussian Blur Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .image-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
        }
        
        .portrait-rotated {
            transform: rotate(90deg) !important;
            transform-origin: center center !important;
        }
        
        .portrait-container {
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
        }
        
        .blur-overlay {
            position: absolute;
            border: 3px solid rgba(220, 53, 69, 0.8);
            background: rgba(220, 53, 69, 0.15);
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
            overflow: hidden;
            backdrop-filter: blur(1px);
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }
        
        .blur-overlay:hover {
            border-color: rgba(220, 53, 69, 1);
            background: rgba(220, 53, 69, 0.25);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
        }
        
        /* Violation type specific colors */
        .blur-overlay[data-part*="GENITALIA"] {
            border-color: rgba(142, 68, 173, 0.8);
            background: rgba(142, 68, 173, 0.15);
            box-shadow: 0 2px 8px rgba(142, 68, 173, 0.3);
        }
        
        .blur-overlay[data-part*="BREAST"] {
            border-color: rgba(231, 76, 60, 0.8);
            background: rgba(231, 76, 60, 0.15);
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.3);
        }
        
        .blur-overlay[data-part*="BUTTOCKS"] {
            border-color: rgba(255, 107, 53, 0.8);
            background: rgba(255, 107, 53, 0.15);
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
        }
        
        .blur-overlay[data-part*="ARMPITS"] {
            border-color: rgba(243, 156, 18, 0.8);
            background: rgba(243, 156, 18, 0.15);
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.3);
        }
        
        .blur-overlay[data-part*="FACE"] {
            border-color: rgba(52, 152, 219, 0.8);
            background: rgba(52, 152, 219, 0.15);
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
        }
        
        /* Shape styling for blur overlays */
        .blur-overlay.shape-oval {
            border-radius: 50%;
        }
        
        .blur-overlay.shape-rounded {
            border-radius: 15px;
        }
        
        .blur-overlay.shape-square {
            border-radius: 8px;
        }
        
        /* Confidence label styling */
        .confidence-label {
            position: absolute;
            top: -8px;
            left: -8px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            z-index: 100;
            pointer-events: none;
        }

        /* Resize handles */
        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 50%;
            opacity: 0.8;
            transition: opacity 0.2s;
            z-index: 110;
        }

        .resize-nw { top: -6px; left: -6px; cursor: nw-resize; }
        .resize-ne { top: -6px; right: -6px; cursor: ne-resize; }
        .resize-sw { bottom: -6px; left: -6px; cursor: sw-resize; }
        .resize-se { bottom: -6px; right: -6px; cursor: se-resize; }
        
        .blur-overlay:hover .resize-handle {
            opacity: 1;
        }

        /* Part toggle buttons */
        .part-toggle {
            transition: all 0.3s ease;
            border: 2px solid transparent;
            margin: 2px;
            border-radius: 5px;
            padding: 8px 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            cursor: pointer;
        }
        
        .part-toggle.active {
            background-color: #28a745 !important;
            border-color: #20c997;
            color: white;
        }
        
        .part-toggle.inactive {
            background-color: #dc3545 !important;
            border-color: #c82333;
            color: white;
        }
        
        /* Control styling */
        .control-section {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .upload-section {
            background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
            border: 2px solid #2196F3;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .analysis-section {
            background: linear-gradient(135deg, #FFF3E0 0%, #FFE0B2 100%);
            border: 2px solid #FF9800;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .blur-controls-section {
            background: linear-gradient(135deg, #F3E5F5 0%, #E1BEE7 100%);
            border: 2px solid #9C27B0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .violations-section {
            background: linear-gradient(135deg, #FFEBEE 0%, #FFCDD2 100%);
            border: 2px solid #F44336;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .image-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .btn-action {
            margin: 3px;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-toggle {
            background: #17a2b8;
            color: white;
        }
        
        .btn-toggle:hover {
            background: #138496;
        }
        
        .btn-save {
            background: #28a745;
            color: white;
        }
        
        .btn-save:hover {
            background: #218838;
        }
        
        .btn-reject {
            background: #dc3545;
            color: white;
        }
        
        .btn-reject:hover {
            background: #c82333;
        }
        
        .btn-add {
            background: #007bff;
            color: white;
        }
        
        .btn-add:hover {
            background: #0056b3;
        }
        
        .progress-container {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
            border: 1px solid #dee2e6;
        }
        
        .progress-bar {
            height: 25px;
            transition: width 0.6s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .progress-bar.bg-danger {
            background-color: #dc3545;
        }
        
        .progress-bar.bg-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .progress-bar.bg-info {
            background-color: #17a2b8;
        }
        
        .info-badge {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .info-badge.detected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .info-badge.moderate {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .info-badge.flagged {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
        }
        
        .status-item {
            text-align: center;
            flex: 1;
        }
        
        .status-value {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .status-label {
            font-size: 12px;
            color: #6c757d;
            text-transform: uppercase;
        }
        
        .queue-info {
            background: linear-gradient(135deg, #E8F5E8 0%, #C8E6C9 100%);
            border: 2px solid #4CAF50;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-3">
        <!-- Queue Review Header -->
        <div class="queue-info">
            <h2 class="text-success mb-3">üîç Media Queue Review Tool</h2>
            <div class="row">
                <div class="col-md-3">
                    <strong>Model:</strong> <span id="queueModel">Loading...</span>
                </div>
                <div class="col-md-3">
                    <strong>Priority:</strong> <span id="queuePriority">Loading...</span>
                </div>
                <div class="col-md-3">
                    <strong>Queue Type:</strong> <span id="queueType">Loading...</span>
                </div>
                <div class="col-md-3">
                    <strong>Content Tier:</strong> <span id="queueTier">Loading...</span>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-8">
                <!-- Image Review Section -->
                <div class="image-section">
                    <h5 class="mb-3">üì∏ Image Review</h5>
                    <div id="imageContainer" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading image from queue...</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <!-- AI Analysis Results -->
                <div class="analysis-section">
                    <h6 class="mb-3">üìä AI Analysis Results</h6>
                    
                    <!-- Nudity & Risk Overview -->
                    <div class="mb-4">
                        <h6 class="mb-2">üö® Nudity & Risk Overview</h6>
                        
                        <div class="mb-2">
                            <small class="text-muted">Nudity Score:</small>
                            <div class="progress-container">
                                <div id="nudityProgress" class="progress-bar bg-danger" style="width: 0%">
                                    <span id="nudityScore">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <small class="text-muted">Final Risk Score:</small>
                            <div class="progress-container">
                                <div id="riskProgress" class="progress-bar bg-info" style="width: 0%">
                                    <span id="riskScore">0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="status-container">
                            <div class="status-item">
                                <div id="statusBadge" class="info-badge flagged">FLAGGED</div>
                                <div class="status-label">Status</div>
                            </div>
                            <div class="status-item">
                                <div id="riskBadge" class="info-badge moderate">medium</div>
                                <div class="status-label">Risk Level</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pose & Orientation Info -->
                    <div class="mb-4">
                        <h6 class="mb-2">üßç Pose & Orientation Info</h6>
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="info-badge detected">Detected</div>
                                <div class="status-label">Pose</div>
                            </div>
                            <div class="col-8">
                                <div class="text-start">
                                    <small><strong>Category:</strong> <span id="poseCategory">moderately_suggestive</span></small><br>
                                    <small><strong>Facing:</strong> <span id="poseFacing">facing_camera</span></small><br>
                                    <small><strong>Intent:</strong> <span id="poseIntent">public_site</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detected Content Areas -->
                    <div>
                        <h6 class="mb-2">üéØ Detected Content Areas</h6>
                        <div id="detectedAreas">
                            <!-- Will be populated from queue data -->
                        </div>
                    </div>
                </div>

                <!-- Blur Controls -->
                <div class="blur-controls-section">
                    <h6 class="mb-3">üéõÔ∏è Blur Controls</h6>
                    
                    <div class="mb-3">
                        <label for="blurStrength" class="form-label">Blur Strength:</label>
                        <input type="range" class="form-range" id="blurStrength" min="1" max="50" value="4" oninput="updateBlurStrength()">
                        <div class="d-flex justify-content-between">
                            <small>1</small>
                            <small><strong>Strength: <span id="strengthValue">4</span></strong></small>
                            <small>50</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="blurShape" class="form-label">Blur Shape:</label>
                        <select class="form-select" id="blurShape" onchange="updateBlurShape()">
                            <option value="rectangle">Rectangle</option>
                            <option value="oval">Oval</option>
                            <option value="rounded">Rounded</option>
                        </select>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn-action btn-add" onclick="addCustomBlurArea()">‚ûï Add Blur Area</button>
                        <button class="btn-action btn-toggle" onclick="toggleAllBlurs()">üòé Toggle All Blurs</button>
                        <button class="btn-action btn-save" onclick="saveModeratedVersion()">üíæ Save Moderated Version</button>
                        <button class="btn-action btn-reject" onclick="rejectImage()">‚ùå Reject Image</button>
                    </div>
                </div>

                <!-- Detected Violations -->
                <div class="violations-section">
                    <h6 class="mb-3">‚ö†Ô∏è Detected Violations</h6>
                    <div id="violationsList">
                        <!-- Will be populated from queue data -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Image library for EXIF handling -->
    <script src="https://cdn.jsdelivr.net/npm/blueimp-load-image@5.16.0/js/load-image.all.min.js"></script>
    
    <script>
        // Global variables
        let analysisData = null;
        let currentImage = null;
        let blurStates = {};
        let mediaId = null;
        let queueData = null;

        // Initialize when page loads - get mediaId from URL or parent window
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            mediaId = urlParams.get('mediaId');
            
            if (mediaId) {
                console.log('Loading media from queue:', mediaId);
                loadMediaFromQueue(mediaId);
            } else {
                console.error('No mediaId provided');
                document.getElementById('imageContainer').innerHTML = '<div class="alert alert-danger">No media ID provided for queue review</div>';
            }
        });

        async function loadMediaFromQueue(id) {
            try {
                // Get auth token from parent window if in iframe, or local storage
                const authToken = window.parent?.localStorage?.getItem('phoenix4ge_token') || localStorage.getItem('phoenix4ge_token');
                
                console.log('Fetching media data for ID:', id);
                const response = await fetch(`/api/media-review-queue/item/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error);
                }

                queueData = data.item;
                console.log('Queue data loaded:', queueData);
                
                // Update queue info header
                document.getElementById('queueModel').textContent = queueData.model_name;
                document.getElementById('queuePriority').textContent = queueData.priority.toUpperCase();
                document.getElementById('queueType').textContent = queueData.queue_type.replace('_', ' ').toUpperCase();
                document.getElementById('queueTier').textContent = queueData.usage_intent.replace('_', ' ').toUpperCase();
                
                // Update analysis display
                updateAnalysisDisplay();
                
                // Create analysis data structure from queue data
                analysisData = {
                    part_locations: {},
                    nudity_score: queueData.nudity_score,
                    detected_parts: queueData.detected_parts || {}
                };
                
                // Convert detected parts to locations for blur system
                if (queueData.detected_parts) {
                    Object.entries(queueData.detected_parts).forEach(([part, confidence]) => {
                        // Use default locations - these would come from actual AI coordinates in production
                        const defaultLocations = {
                            'FACE_FEMALE': { x: 0.25, y: 0.1, width: 0.3, height: 0.3 },
                            'FACE': { x: 0.25, y: 0.1, width: 0.3, height: 0.3 },
                            'BREAST_FEMALE': { x: 0.2, y: 0.35, width: 0.4, height: 0.25 },
                            'BREAST': { x: 0.2, y: 0.35, width: 0.4, height: 0.25 },
                            'GENITALIA': { x: 0.35, y: 0.65, width: 0.3, height: 0.2 },
                            'BUTTOCKS': { x: 0.25, y: 0.55, width: 0.4, height: 0.3 }
                        };
                        
                        const location = defaultLocations[part.toUpperCase()] || { x: 0.3, y: 0.3, width: 0.3, height: 0.3 };
                        analysisData.part_locations[part] = location;
                    });
                }
                
                // Load the image using the queue data
                loadImageFromQueueData(queueData);
                
            } catch (error) {
                console.error('Error loading media from queue:', error);
                document.getElementById('imageContainer').innerHTML = `<div class="alert alert-danger">Error loading media: ${error.message}</div>`;
            }
        }

        function updateAnalysisDisplay() {
            // Update nudity score
            const nudityScore = queueData.nudity_score || 0;
            document.getElementById('nudityScore').textContent = nudityScore.toFixed(1) + '%';
            document.getElementById('nudityProgress').style.width = nudityScore + '%';
            
            // Update risk score (same as nudity for now)
            document.getElementById('riskScore').textContent = nudityScore.toFixed(1) + '%';
            document.getElementById('riskProgress').style.width = nudityScore + '%';
            
            // Update status badges
            const statusBadge = document.getElementById('statusBadge');
            const riskBadge = document.getElementById('riskBadge');
            
            if (nudityScore > 85) {
                statusBadge.textContent = 'FLAGGED';
                statusBadge.className = 'info-badge flagged';
                riskBadge.textContent = 'high';
                riskBadge.className = 'info-badge flagged';
            } else if (nudityScore > 50) {
                statusBadge.textContent = 'FLAGGED';
                statusBadge.className = 'info-badge moderate';
                riskBadge.textContent = 'medium';
                riskBadge.className = 'info-badge moderate';
            } else {
                statusBadge.textContent = 'CLEAR';
                statusBadge.className = 'info-badge detected';
                riskBadge.textContent = 'low';
                riskBadge.className = 'info-badge detected';
            }
            
            // Update detected areas
            updateDetectedAreas();
            updateViolationsList();
        }

        function updateDetectedAreas() {
            const detectedAreas = document.getElementById('detectedAreas');
            const parts = queueData.detected_parts || {};
            
            if (Object.keys(parts).length === 0) {
                detectedAreas.innerHTML = '<small class="text-muted">No violations detected</small>';
                return;
            }
            
            let areasHtml = '';
            Object.entries(parts).forEach(([part, confidence]) => {
                areasHtml += `<div class="info-badge moderate mb-1">${part}: ${confidence.toFixed(1)}%</div><br>`;
            });
            
            detectedAreas.innerHTML = areasHtml;
        }

        function updateViolationsList() {
            const violationsList = document.getElementById('violationsList');
            const parts = queueData.detected_parts || {};
            
            if (Object.keys(parts).length === 0) {
                violationsList.innerHTML = '<small class="text-muted">No violations detected</small>';
                return;
            }
            
            let violationsHtml = '';
            Object.entries(parts).forEach(([part, confidence]) => {
                const isBlurred = blurStates[part] !== false; // Default to blurred
                const buttonClass = isBlurred ? 'part-toggle active' : 'part-toggle inactive';
                const buttonText = isBlurred ? 'Blurred' : 'Unblur';
                
                violationsHtml += `
                    <div class="${buttonClass}" onclick="toggleBlurPart('${part}')" style="display: block; width: 100%; margin-bottom: 5px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${part.charAt(0) + part.slice(1).toLowerCase()}</span>
                            <span>${confidence.toFixed(1)}%</span>
                        </div>
                        <div style="font-size: 9px; opacity: 0.8;">${buttonText}</div>
                    </div>
                `;
            });
            
            violationsList.innerHTML = violationsHtml;
        }

        function loadImageFromQueueData(data) {
            // Use the image path from queue data
            const imagePath = data.full_path || data.thumbnail_path || data.original_path;
            
            if (!imagePath) {
                document.getElementById('imageContainer').innerHTML = '<div class="alert alert-danger">No image path found in queue data</div>';
                return;
            }
            
            console.log('Loading image from path:', imagePath);
            
            // Load image with EXIF handling (same as original tool)
            fetch(imagePath)
                .then(response => response.blob())
                .then(blob => {
                    displayImageWithViolations(blob, analysisData);
                })
                .catch(error => {
                    console.error('Error loading image:', error);
                    document.getElementById('imageContainer').innerHTML = '<div class="alert alert-danger">Failed to load image</div>';
                });
        }

        // Copy ALL the working functions from the original tool below this line
        // (This preserves all the drag/resize/blur logic exactly as it works)
        
        function displayImageWithViolations(file, analysis) {
            analysisData = analysis;
            
            console.log('üì∏ Loading image in EXIF-stripped mode to match NudeNet coordinate space...');
            
            // Load image with EXIF orientation disabled to match backend processing  
            loadImage(file, function (canvas) {
                if (canvas.type === "error") {
                    console.error("Failed to load image in EXIF-stripped mode:", canvas);
                    return;
                }
                
                console.log('‚úÖ Using EXIF-stripped coordinate space (matching NudeNet and backend blur processing)');
                
                // Use the raw EXIF-stripped canvas directly - no landscape conversion
                let finalCanvas = canvas;
                
                console.log('üñºÔ∏è Moderation canvas (EXIF-stripped):', finalCanvas.width, 'x', finalCanvas.height);
                
                const container = document.getElementById('imageContainer');
                container.innerHTML = `
                    <div class="image-container">
                    </div>
                `;
                const imageContainer = container.querySelector('.image-container');
                
                finalCanvas.className = 'image-preview';
                finalCanvas.style.maxWidth = '100%';
                finalCanvas.style.height = 'auto';
                finalCanvas.style.display = 'block';
                
                imageContainer.appendChild(finalCanvas);
                
                currentImage = {
                    naturalWidth: finalCanvas.width,
                    naturalHeight: finalCanvas.height,
                    canvas: finalCanvas
                };
                
                // Reset blur controls to default state
                resetBlurControlsToDefault();
                
                processImageWithAnalysis(finalCanvas, analysis);
                
            }, {
                orientation: 1,
                canvas: true
            });
        }
            
        function processImageWithAnalysis(canvas, analysis) {
                const container = document.getElementById('imageContainer');
                
                // Store the canvas as current image for consistent access
                currentImage = {
                    naturalWidth: canvas.width,
                    naturalHeight: canvas.height,
                    canvas: canvas
                };
                
                // Create image container with overlays
                let overlaysHtml = '';
                let violationsHtml = '';
                
                if (analysis.part_locations) {
                    Object.entries(analysis.part_locations).forEach(([part, location]) => {
                        const overlayId = `overlay-${part}`;
                        blurStates[part] = true; // Default to blurred
                        
                        // Debug coordinates with canvas
                        console.log(`=== CANVAS COORDINATES DEBUG for ${part} ===`);
                        console.log('Raw location object:', location);
                        console.log('Location properties:', Object.keys(location));
                        console.log(`x: ${location.x}, y: ${location.y}, width: ${location.width}, height: ${location.height}`);
                        console.log(`Canvas dimensions: ${canvas.width} x ${canvas.height}`);
                        
                        // Convert proportional coordinates to absolute if needed
                        let pos = location;
                        if (pos.x <= 1 && pos.y <= 1 && pos.width <= 1 && pos.height <= 1) {
                            // Coordinates are proportional, convert to absolute
                            pos = {
                                x: pos.x * canvas.width,
                                y: pos.y * canvas.height,
                                width: pos.width * canvas.width,
                                height: pos.height * canvas.height
                            };
                        }
                        
                        console.log(`Final coordinates for ${part}:`, pos);
                        
                        // Get displayed image dimensions for scaling
                        const displayedWidth = canvas.offsetWidth || canvas.width;
                        const displayedHeight = canvas.offsetHeight || canvas.height;
                        
                        // Calculate scaling factors
                        const scaleX = displayedWidth / canvas.width;
                        const scaleY = displayedHeight / canvas.height;
                        
                        // Scale coordinates to displayed size
                        const scaledX = pos.x * scaleX;
                        const scaledY = pos.y * scaleY;
                        const scaledWidth = pos.width * scaleX;
                        const scaledHeight = pos.height * scaleY;
                        
                        console.log(`Scaled coordinates: x=${scaledX}, y=${scaledY}, w=${scaledWidth}, h=${scaledHeight}`);
                        
                        overlaysHtml += `
                            <div class="blur-overlay" 
                                 id="${overlayId}"
                                 data-part="${part}"
                                 style="left: ${scaledX}px; top: ${scaledY}px; width: ${scaledWidth}px; height: ${scaledHeight}px;">
                                <div class="confidence-label">${part}: ${queueData.detected_parts[part]?.toFixed(1) || 100}%</div>
                                <div class="resize-handle resize-nw"></div>
                                <div class="resize-handle resize-ne"></div>
                                <div class="resize-handle resize-sw"></div>
                                <div class="resize-handle resize-se"></div>
                            </div>
                        `;
                    });
                }
                
                // Add overlays to image container
                const imageContainer = container.querySelector('.image-container');
                imageContainer.insertAdjacentHTML('beforeend', overlaysHtml);
                
                // Initialize drag/resize functionality and blur previews
                setTimeout(() => {
                    console.log('Initializing blur overlays...');
                    document.querySelectorAll('.blur-overlay').forEach((overlay, index) => {
                        addDragResize(overlay);
                        const blurStrength = parseInt(document.getElementById('blurStrength').value);
                        updateCanvasBlurPreview(overlay, blurStrength);
                    });
                    
                    syncAllBlurPreviews();
                    updateViolationsList(); // Update the violations list after overlays are created
                    console.log('Blur system initialized successfully');
                }, 100);
        }

        function resetBlurControlsToDefault() {
            document.getElementById('blurStrength').value = 4;
            document.getElementById('strengthValue').textContent = '4';
            document.getElementById('blurShape').value = 'rectangle';
        }

        function toggleBlurPart(part) {
            if (blurStates[part] === undefined) {
                blurStates[part] = true;
            }
            blurStates[part] = !blurStates[part];
            
            const overlay = document.getElementById(`overlay-${part}`);
            if (overlay) {
                const strength = blurStates[part] ? parseInt(document.getElementById('blurStrength').value) : 0;
                updateCanvasBlurPreview(overlay, strength);
                
                console.log(`${blurStates[part] ? 'Enabled' : 'Disabled'} blur for ${part}`);
            }
            
            // Update violations list to reflect new state
            updateViolationsList();
        }

        function updateCanvasBlurPreview(overlay, blurStrength) {
            if (!overlay) {
                return;
            }
            
            // Remove any existing canvas
            const existingCanvas = overlay.querySelector('.blur-preview-canvas');
            if (existingCanvas) {
                existingCanvas.remove();
            }
            
            // Apply CSS backdrop-filter blur for preview
            if (blurStrength > 0) {
                // CSS backdrop-filter is much weaker than Sharp.js Gaussian blur
                // Use a multiplier to make the preview more representative of final result
                const cssBlurIntensity = Math.min(100, blurStrength * 2.5); // Cap at 100px for performance
                const opacity = Math.min(0.2, blurStrength / 100); // Much lighter overlay to match Sharp.js
                
                overlay.style.backdropFilter = `blur(${cssBlurIntensity}px)`;
                overlay.style.backgroundColor = `rgba(255, 255, 255, ${opacity})`;
                
                console.log(`Applied ${cssBlurIntensity}px backdrop-filter (from ${blurStrength}px backend) to ${overlay.dataset.part}`);
            } else {
                overlay.style.backdropFilter = 'none';
                overlay.style.backgroundColor = 'rgba(200, 200, 200, 0.2)';
            }
        }

        function syncAllBlurPreviews() {
            const strength = parseInt(document.getElementById('blurStrength')?.value || 4);
            document.querySelectorAll('.blur-overlay').forEach(overlay => {
                console.log(`üîÅ Syncing blur for: ${overlay.dataset.part}`);
                updateCanvasBlurPreview(overlay, strength);
            });
        }

        function updateBlurStrength() {
            const strength = document.getElementById('blurStrength').value;
            document.getElementById('strengthValue').textContent = strength;
            syncAllBlurPreviews();
        }

        function updateBlurShape() {
            const shape = document.getElementById('blurShape').value;
            document.querySelectorAll('.blur-overlay').forEach(overlay => {
                overlay.className = overlay.className.replace(/shape-\w+/g, '');
                overlay.classList.add(`shape-${shape}`);
            });
        }

        function addDragResize(overlay) {
            let isDragging = false;
            let isResizing = false;
            let currentHandle = null;
            let startX, startY, startLeft, startTop, startWidth, startHeight;

            // Make overlay draggable
            overlay.addEventListener('mousedown', function(e) {
                if (e.target.classList.contains('resize-handle')) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = parseInt(overlay.style.left);
                startTop = parseInt(overlay.style.top);
                
                overlay.style.zIndex = '200';
                e.preventDefault();
            });

            // Add resize functionality to handles
            overlay.querySelectorAll('.resize-handle').forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    currentHandle = handle;
                    startX = e.clientX;
                    startY = e.clientY;
                    startLeft = parseInt(overlay.style.left);
                    startTop = parseInt(overlay.style.top);
                    startWidth = parseInt(overlay.style.width);
                    startHeight = parseInt(overlay.style.height);
                    
                    overlay.style.zIndex = '200';
                    e.stopPropagation();
                    e.preventDefault();
                });
            });

            // Global mouse move handler
            document.addEventListener('mousemove', function(e) {
                if (isDragging) {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    overlay.style.left = (startLeft + deltaX) + 'px';
                    overlay.style.top = (startTop + deltaY) + 'px';
                }
                
                if (isResizing && currentHandle) {
                    const deltaX = e.clientX - startX;
                    const deltaY = e.clientY - startY;
                    
                    let newLeft = startLeft;
                    let newTop = startTop;
                    let newWidth = startWidth;
                    let newHeight = startHeight;
                    
                    if (currentHandle.classList.contains('resize-nw')) {
                        newLeft = startLeft + deltaX;
                        newTop = startTop + deltaY;
                        newWidth = startWidth - deltaX;
                        newHeight = startHeight - deltaY;
                    } else if (currentHandle.classList.contains('resize-ne')) {
                        newTop = startTop + deltaY;
                        newWidth = startWidth + deltaX;
                        newHeight = startHeight - deltaY;
                    } else if (currentHandle.classList.contains('resize-sw')) {
                        newLeft = startLeft + deltaX;
                        newWidth = startWidth - deltaX;
                        newHeight = startHeight + deltaY;
                    } else if (currentHandle.classList.contains('resize-se')) {
                        newWidth = startWidth + deltaX;
                        newHeight = startHeight + deltaY;
                    }
                    
                    // Enforce minimum size
                    if (newWidth < 20) newWidth = 20;
                    if (newHeight < 20) newHeight = 20;
                    
                    overlay.style.left = newLeft + 'px';
                    overlay.style.top = newTop + 'px';
                    overlay.style.width = newWidth + 'px';
                    overlay.style.height = newHeight + 'px';
                }
            });

            // Global mouse up handler
            document.addEventListener('mouseup', function() {
                if (isDragging || isResizing) {
                    overlay.style.zIndex = '100';
                }
                isDragging = false;
                isResizing = false;
                currentHandle = null;
            });
        }

        function addCustomBlurArea() {
            alert('Click and drag on the image to add a custom blur area (feature available in full tool)');
        }

        function toggleAllBlurs() {
            const allBlurred = Object.values(blurStates).every(state => state !== false);
            
            Object.keys(blurStates).forEach(part => {
                if (allBlurred) {
                    blurStates[part] = false;
                } else {
                    blurStates[part] = true;
                }
                toggleBlurPart(part);
            });
        }

        function saveModeratedVersion() {
            if (confirm('Save the moderated version with current blur settings?')) {
                // Collect blur areas data
                const blurAreas = [];
                document.querySelectorAll('.blur-overlay').forEach(overlay => {
                    const part = overlay.dataset.part;
                    if (blurStates[part] !== false) { // If blurred
                        blurAreas.push({
                            part: part,
                            x: parseInt(overlay.style.left),
                            y: parseInt(overlay.style.top),
                            width: parseInt(overlay.style.width),
                            height: parseInt(overlay.style.height),
                            strength: parseInt(document.getElementById('blurStrength').value)
                        });
                    }
                });
                
                // Call parent window function if in iframe to approve with blur
                if (window.parent && window.parent.systemAdminDashboard) {
                    window.parent.systemAdminDashboard.approveWithEnhancedBlur(mediaId);
                } else {
                    console.log('Saving moderated version with blur areas:', blurAreas);
                    alert('Moderated version saved successfully!');
                }
            }
        }

        function rejectImage() {
            const reason = prompt('Please provide a reason for rejection:');
            if (reason) {
                // Call parent window function if in iframe
                if (window.parent && window.parent.systemAdminDashboard) {
                    window.parent.systemAdminDashboard.rejectContent(mediaId);
                } else {
                    console.log('Rejecting image with reason:', reason);
                    alert('Image rejected: ' + reason);
                }
            }
        }
    </script>
</body>
</html>