<!-- Auto-Save Form Input Component -->
<!-- Usage: Add class="auto-save" and data-endpoint to any input -->
<!-- Dependencies: Bootstrap 5 -->

<div class="form-group position-relative">
    <label for="{{field_name}}" class="form-label">{{label}}</label>
    <input 
        type="{{input_type}}" 
        class="form-control auto-save {{css_classes}}" 
        id="{{field_name}}" 
        name="{{field_name}}" 
        value="{{value}}" 
        data-endpoint="{{endpoint}}"
        data-resource-id="{{resource_id}}"
        data-save-mode="{{save_mode}}"
        placeholder="{{placeholder}}"
        {{required}}
    >
    <div class="save-indicator position-absolute" style="right: 10px; top: 32px; display: none;">
        <i class="fas fa-check-circle text-success" data-status="success"></i>
        <i class="fas fa-exclamation-circle text-danger" data-status="error"></i>
        <i class="fas fa-spinner fa-spin text-primary" data-status="saving"></i>
    </div>
    <div class="invalid-feedback" data-error-message></div>
</div>

<script>
// Auto-save functionality
async function autoSaveField(element) {
    const endpoint = element.dataset.endpoint;
    const resourceId = element.dataset.resourceId;
    const fieldName = element.name;
    const value = element.value;
    const saveMode = element.dataset.saveMode || 'field';
    
    if (!endpoint || !resourceId) return;
    
    const indicator = element.parentElement.querySelector('.save-indicator');
    const errorDiv = element.parentElement.querySelector('[data-error-message]');
    
    // Show saving indicator
    showSaveIndicator(indicator, 'saving');
    
    try {
        const response = await fetch(`${endpoint}/${resourceId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            },
            body: JSON.stringify({ [fieldName]: value })
        });
        
        if (response.ok) {
            showSaveIndicator(indicator, 'success');
            element.classList.remove('is-invalid');
            errorDiv.textContent = '';
        } else {
            const errorData = await response.json();
            showSaveIndicator(indicator, 'error');
            element.classList.add('is-invalid');
            errorDiv.textContent = errorData.error || 'Save failed';
        }
    } catch (error) {
        showSaveIndicator(indicator, 'error');
        element.classList.add('is-invalid');
        errorDiv.textContent = 'Network error';
        console.error('Auto-save failed:', error);
    }
}

function showSaveIndicator(indicator, status) {
    // Hide all status icons
    indicator.querySelectorAll('[data-status]').forEach(icon => {
        icon.style.display = 'none';
    });
    
    // Show current status
    const statusIcon = indicator.querySelector(`[data-status="${status}"]`);
    if (statusIcon) {
        statusIcon.style.display = 'inline';
        indicator.style.display = 'block';
    }
    
    // Auto-hide success/error after 2 seconds
    if (status === 'success' || status === 'error') {
        setTimeout(() => {
            indicator.style.display = 'none';
        }, 2000);
    }
}

// Attach auto-save to all inputs with auto-save class
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.auto-save').forEach(input => {
        const saveMode = input.dataset.saveMode || 'field';
        
        if (saveMode === 'field') {
            // Save on blur (when user leaves field)
            input.addEventListener('blur', () => autoSaveField(input));
        } else if (saveMode === 'batch') {
            // Debounced save on input
            let timeout;
            input.addEventListener('input', () => {
                clearTimeout(timeout);
                timeout = setTimeout(() => autoSaveField(input), 2500);
            });
        }
    });
});
</script>

<style>
.auto-save.is-invalid {
    border-color: #dc3545;
}

.save-indicator {
    z-index: 10;
}

.save-indicator i {
    font-size: 14px;
}
</style>