<!-- Gallery Page Content Editor - Simplified Settings -->
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2 text-gray-800">
                        <i class="fas fa-images text-success me-2"></i>
                        Gallery Page Settings
                    </h1>
                    <p class="text-muted mb-0">Configure your gallery page hero section and content selection</p>
                </div>
                <div class="d-flex gap-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input auto-save-field" type="checkbox" id="page_published" data-field="page_published">
                        <label class="form-check-label fw-bold text-warning" for="page_published" id="publish-label">
                            <i class="fas fa-eye-slash me-1"></i>Draft
                        </label>
                    </div>
                    <a href="#" onclick="window.history.back()" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Content Hub
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-save Status -->
    <div id="auto-save-status" class="alert alert-info d-none">
        <i class="fas fa-spinner fa-spin me-2"></i>
        <span id="save-status-text">Saving...</span>
    </div>

    <!-- Settings Content -->
    <div class="row g-4">
        <div class="col-12">
            <!-- Hero Section -->
            <div class="card shadow-sm">
                <div class="card-header bg-success bg-opacity-10">
                    <h4 class="mb-0 text-success">
                        <i class="fas fa-image me-2"></i>Hero Section
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-lg-6">
                            <div class="bg-light rounded p-4">
                                <h5 class="text-success mb-3">
                                    <i class="fas fa-cog me-2"></i>Page Header
                                </h5>
                                
                                <div class="enhanced-field mb-3">
                                    <label class="form-label fw-bold">Page Title</label>
                                    <input type="text" class="form-control auto-save-field" 
                                           id="page_title" 
                                           data-field="page_title"
                                           placeholder="Gallery">
                                    <div class="save-status mt-1"></div>
                                </div>
                                
                                <div class="enhanced-field mb-3">
                                    <label class="form-label fw-bold">Page Subtitle</label>
                                    <input type="text" class="form-control auto-save-field" 
                                           id="page_subtitle" 
                                           data-field="page_subtitle"
                                           placeholder="Explore my collection">
                                    <div class="save-status mt-1"></div>
                                </div>
                                
                                <div class="enhanced-field mb-3">
                                    <label class="form-label fw-bold">Page Description</label>
                                    <textarea class="form-control auto-save-field" 
                                              id="page_description" 
                                              data-field="page_description"
                                              rows="3"
                                              placeholder="Brief description of your gallery"></textarea>
                                    <div class="save-status mt-1"></div>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input auto-save-field" type="checkbox" 
                                           id="gallery_header_visible" data-field="gallery_header_visible" checked>
                                    <label class="form-check-label fw-bold" for="gallery_header_visible">
                                        Show Header
                                    </label>
                                    <div class="save-status mt-1"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="bg-light rounded p-4">
                                <h5 class="text-warning mb-3">
                                    <i class="fas fa-camera me-2"></i>Background Image
                                </h5>
                                
                                <div class="enhanced-field mb-3">
                                    <label class="form-label fw-bold">
                                        Background Image
                                        <i class="fas fa-info-circle text-info ms-1" 
                                           data-bs-toggle="tooltip" 
                                           data-bs-placement="top" 
                                           title="For best results, use high-resolution images: 1920×1200px or larger, landscape orientation, under 500KB file size. Images will be used as parallax backgrounds."></i>
                                    </label>
                                    <select class="form-select auto-save-field" 
                                            id="hero_background_image_id" 
                                            data-field="hero_background_image_id">
                                        <option value="">No custom background (use default)</option>
                                        <!-- Gallery images will be populated here -->
                                    </select>
                                    <div class="save-status mt-1"></div>
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb text-warning me-1"></i>
                                        <strong>Tip:</strong> Use high-resolution landscape images (1920×1200px+) for best parallax effect. 
                                        Images should be under 500KB for fast loading.
                                    </small>
                                </div>
                                
                                <!-- Hero Background Preview -->
                                <div id="hero-background-preview" class="d-none mb-3">
                                    <div class="position-relative">
                                        <img id="hero-background-preview-img" 
                                             src="" 
                                             alt="Hero background preview" 
                                             class="img-fluid rounded" 
                                             style="max-height: 120px; width: 100%; object-fit: cover;">
                                        <div class="position-absolute top-0 end-0 p-2">
                                            <span class="badge bg-success">
                                                <i class="fas fa-check me-1"></i>Selected
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="enhanced-field">
                                    <label class="form-label fw-bold">Background Opacity</label>
                                    <div class="d-flex align-items-center gap-3">
                                        <input type="range" class="form-range auto-save-field flex-grow-1" 
                                               id="hero_background_opacity" 
                                               data-field="hero_background_opacity"
                                               min="0" max="1" step="0.1" value="0.4">
                                        <span class="text-muted small" id="opacity-value">40%</span>
                                    </div>
                                    <div class="save-status mt-1"></div>
                                    <small class="text-muted">Controls the overlay darkness over the background image</small>
                                </div>
                                
                                <!-- Image Guidelines Alert -->
                                <div class="alert alert-info mt-3" role="alert">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-camera text-info me-2 mt-1"></i>
                                        <div>
                                            <h6 class="alert-heading mb-2">
                                                <i class="fas fa-star text-warning me-1"></i>Hero Background Image Guidelines
                                            </h6>
                                            <ul class="mb-0 small">
                                                <li><strong>Dimensions:</strong> 1920×1200px or larger for best quality</li>
                                                <li><strong>Orientation:</strong> Landscape format works best for hero sections</li>
                                                <li><strong>File Size:</strong> Keep under 500KB for fast page loading</li>
                                                <li><strong>Subject Matter:</strong> Choose images with clear focal points that work with text overlay</li>
                                                <li><strong>Parallax Effect:</strong> Taller images (1200px+ height) create better parallax scrolling</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vertical Spacer -->
            <div class="py-4"></div>

            <!-- Gallery Content Selection -->
            <div class="card shadow-sm">
                <div class="card-header bg-warning bg-opacity-10">
                    <h4 class="mb-0 text-warning">
                        <i class="fas fa-list-check me-2"></i>Gallery Content Selection
                    </h4>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Drag galleries from Available to Selected to display them on your public gallery page.
                        Reorder selected galleries by dragging them up or down to control display sequence.
                    </small>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <!-- Selected Galleries (Left Panel) -->
                        <div class="col-lg-6">
                            <div class="drag-panel">
                                <div class="drag-panel-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Selected for Gallery Page
                                    </h5>
                                    <small class="text-muted">These galleries will be displayed in this order</small>
                                </div>
                                <div class="drag-panel-body" id="selected-galleries">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-success" role="status">
                                            <span class="visually-hidden">Loading selected galleries...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading selected galleries...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Available Galleries (Right Panel) -->
                        <div class="col-lg-6">
                            <div class="drag-panel">
                                <div class="drag-panel-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-layer-group text-primary me-2"></i>
                                        Available Galleries
                                    </h5>
                                    <small class="text-muted">Published gallery sections available for selection</small>
                                </div>
                                <div class="drag-panel-body" id="available-galleries">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading gallery sections...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading available gallery sections...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 d-flex justify-content-between align-items-center">
                        <div class="text-muted">
                            <small id="save-status-indicator"><i class="fas fa-info-circle me-1"></i>Changes are saved automatically</small>
                        </div>
                        <div>
                            <button type="button" class="btn btn-outline-secondary" onclick="GalleryPageEditor.resetToDefaults()">
                                <i class="fas fa-undo me-2"></i>Reset to Defaults
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Drag and Drop CSS -->
<style>
.drag-panel {
    border: 2px dashed #e0e0e0;
    border-radius: 8px;
    min-height: 300px;
    transition: border-color 0.3s ease;
}

.drag-panel.drag-over {
    border-color: #007bff;
    background-color: rgba(0, 123, 255, 0.05);
}

.drag-panel-header {
    padding: 1rem;
    border-bottom: 1px solid #e0e0e0;
    background-color: #f8f9fa;
    border-radius: 6px 6px 0 0;
}

.drag-panel-body {
    padding: 1rem;
    min-height: 250px;
}

.gallery-item {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 10px;
    cursor: move;
    transition: all 0.2s ease;
    position: relative;
}

.gallery-item:hover {
    border-color: #007bff;
    box-shadow: 0 2px 8px rgba(0,123,255,0.15);
    transform: translateY(-2px);
}

.gallery-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.gallery-item-handle {
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    color: #999;
    font-size: 16px;
}

.gallery-item-content {
    margin-left: 24px;
}

.gallery-item-title {
    font-weight: 600;
    margin-bottom: 4px;
    color: #333;
}

.gallery-item-meta {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.875rem;
    color: #666;
}

.gallery-item-layout {
    background-color: #f8f9fa;
    color: #495057;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 500;
}

.gallery-item-remove {
    position: absolute;
    right: 8px;
    top: 8px;
    width: 24px;
    height: 24px;
    border: none;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    font-size: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.2s ease;
}

.gallery-item:hover .gallery-item-remove {
    opacity: 1;
}

.drag-panel-empty {
    text-align: center;
    color: #999;
    padding: 2rem;
}

.enhanced-field {
    position: relative;
}

.save-status {
    font-size: 0.75rem;
    min-height: 16px;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.save-status.show {
    opacity: 1;
}

.save-status.success {
    color: #28a745;
}

.save-status.error {
    color: #dc3545;
}
</style>

<script>
window.GalleryPageEditor = {
    currentModelSlug: null,
    allSections: null,
    selectedSections: [],
    
    async init() {
        this.extractModelSlug();
        await this.loadContent();
        await this.loadGalleryOptions();
        this.bindAutoSave();
        this.loadGallerySections();
        this.initOpacitySlider();
    },
    
    extractModelSlug() {
        const pathParts = window.location.pathname.split('/');
        this.currentModelSlug = pathParts[1];
    },
    
    async loadContent() {
        try {
            const response = await fetch(`/api/model-content-new/${this.currentModelSlug}/gallery`);
            const data = await response.json();
            
            if (data.success && data.data) {
                this.populateFormFields(data.data);
            }
        } catch (error) {
            console.error('Error loading gallery page content:', error);
        }
    },
    
    populateFormFields(content) {
        // Store content data for use by other functions
        this.contentData = content;
        
        // Populate form fields
        const fields = [
            'page_title', 'page_subtitle', 'page_description', 
            'gallery_header_visible', 'page_published', 'hero_background_image_id', 'hero_background_opacity'
        ];
        
        fields.forEach(field => {
            const element = document.getElementById(field);
            if (element) {
                if (element.type === 'checkbox') {
                    element.checked = content[field] == 1;
                } else {
                    element.value = content[field] || '';
                }
            }
        });
        
        // Handle selected sections
        if (content.selected_sections) {
            try {
                this.selectedSections = typeof content.selected_sections === 'string' 
                    ? JSON.parse(content.selected_sections) 
                    : content.selected_sections;
            } catch (e) {
                this.selectedSections = [];
            }
        }
        
        // Update publish status
        const publishToggle = document.getElementById('page_published');
        const publishLabel = document.getElementById('publish-label');
        if (publishToggle && publishLabel) {
            const isPublished = content.page_published == 1;
            publishToggle.checked = isPublished;
            publishLabel.innerHTML = isPublished 
                ? '<i class="fas fa-eye me-1"></i>Published'
                : '<i class="fas fa-eye-slash me-1"></i>Draft';
            publishLabel.className = isPublished 
                ? 'form-check-label fw-bold text-success'
                : 'form-check-label fw-bold text-warning';
        }
        
        // Update hero background preview
        this.updateHeroBackgroundPreview();
        
        // Update opacity display
        this.updateOpacityDisplay();
    },
    
    async loadGalleryOptions() {
        try {
            // Load approved gallery images for hero background selection
            const imagesResponse = await fetch(`/api/model-gallery/${this.currentModelSlug}/available-images?status=approved&context=public_site`);
            const imagesData = await imagesResponse.json();
            
            if (imagesData.success && imagesData.data && imagesData.data.images) {
                const heroBackgroundSelect = document.getElementById('hero_background_image_id');
                
                // Store image data for preview
                this.imageData = {};
                
                imagesData.data.images.forEach(image => {
                    // Add option to hero background dropdown
                    const option = document.createElement('option');
                    option.value = image.id;
                    option.textContent = `${image.filename} (${image.moderation_status || 'approved'})`;
                    heroBackgroundSelect.appendChild(option);
                    
                    // Store image data for preview
                    this.imageData[image.id] = image;
                });
                
                // Set hero background selection from content data if available
                if (this.contentData && this.contentData.hero_background_image_id) {
                    heroBackgroundSelect.value = this.contentData.hero_background_image_id;
                    console.log('Set hero background image selection to:', this.contentData.hero_background_image_id);
                    this.updateHeroBackgroundPreview();
                }
                
                // Preview will be handled by the auto-save change event
                // No need for separate event listener
            }
        } catch (error) {
            console.error('Error loading gallery options:', error);
        }
    },
    
    bindAutoSave() {
        const autoSaveFields = document.querySelectorAll('.auto-save-field');
        
        autoSaveFields.forEach(field => {
            field.addEventListener('input', () => this.autoSave(field));
            field.addEventListener('change', () => this.autoSave(field));
        });
    },
    
    async autoSave(field) {
        const fieldName = field.dataset.field;
        let fieldValue = field.value;
        
        // Handle checkboxes
        if (field.type === 'checkbox') {
            fieldValue = field.checked ? 1 : 0;
        }
        
        // Handle range inputs
        if (field.type === 'range') {
            fieldValue = parseFloat(field.value);
        }
        
        try {
            const response = await fetch(`/api/model-content-new/${this.currentModelSlug}/gallery`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    [fieldName]: fieldValue
                })
            });
            
            const result = await response.json();
            this.showSaveStatus(field, result.success);
            
            // Handle special cases
            if (fieldName === 'page_published') {
                this.updatePublishLabel(fieldValue == 1);
            } else if (fieldName === 'hero_background_image_id') {
                // Update preview when hero background image changes
                this.updateHeroBackgroundPreview();
            }
            
            if (fieldName === 'hero_background_opacity') {
                this.updateOpacityDisplay();
            }
            
        } catch (error) {
            console.error('Auto-save error:', error);
            this.showSaveStatus(field, false);
        }
    },
    
    showSaveStatus(field, success) {
        const statusElement = field.parentNode.querySelector('.save-status');
        if (statusElement) {
            statusElement.textContent = success ? '✓ Saved' : '✗ Error';
            statusElement.className = `save-status show ${success ? 'success' : 'error'}`;
            
            setTimeout(() => {
                statusElement.classList.remove('show');
            }, 2000);
        }
    },
    
    updatePublishLabel(isPublished) {
        const publishLabel = document.getElementById('publish-label');
        if (publishLabel) {
            publishLabel.innerHTML = isPublished 
                ? '<i class="fas fa-eye me-1"></i>Published'
                : '<i class="fas fa-eye-slash me-1"></i>Draft';
            publishLabel.className = isPublished 
                ? 'form-check-label fw-bold text-success'
                : 'form-check-label fw-bold text-warning';
        }
    },
    
    initOpacitySlider() {
        const slider = document.getElementById('hero_background_opacity');
        if (slider) {
            slider.addEventListener('input', () => {
                this.updateOpacityDisplay();
            });
        }
    },
    
    updateOpacityDisplay() {
        const slider = document.getElementById('hero_background_opacity');
        const display = document.getElementById('opacity-value');
        if (slider && display) {
            const value = Math.round(parseFloat(slider.value) * 100);
            display.textContent = `${value}%`;
        }
    },
    
    async loadGallerySections() {
        try {
            const response = await fetch(`/api/model-gallery-sections/${this.currentModelSlug}`);
            const data = await response.json();
            
            if (data.success && data.sections) {
                this.allSections = data.sections;
                this.renderDragAndDropInterface();
            } else if (data.success && data.data) {
                // Handle different response format
                this.allSections = data.data;
                this.renderDragAndDropInterface();
            } else {
                console.error('Unexpected API response format:', data);
                this.showGallerySectionsError();
            }
        } catch (error) {
            console.error('Error loading gallery sections:', error);
            this.showGallerySectionsError();
        }
    },
    
    renderDragAndDropInterface() {
        this.populateAvailableGalleries();
        this.populateSelectedGalleries();
        
        // Initialize drag and drop after a short delay to ensure DOM is ready
        setTimeout(() => {
            this.initializeDragAndDrop();
        }, 100);
    },
    
    populateAvailableGalleries() {
        const container = document.getElementById('available-galleries');
        if (!container || !this.allSections) return;
        
        // Filter to only show published galleries that are not already selected
        const availableSections = this.allSections.filter(section => {
            // Must be published/public (not hidden)
            const isPublished = section.is_published === 1 || section.is_published === true;
            // Must not already be selected
            const isNotSelected = !this.isSectionSelected(section.id);
            
            // Note: Hidden/unpublished galleries are automatically filtered out
            
            return isPublished && isNotSelected;
        });
        
        if (availableSections.length === 0) {
            container.innerHTML = `
                <div class="drag-panel-empty">
                    <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                    <p>All galleries are selected</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = availableSections.map(section => 
            this.renderGalleryItem(section, false)
        ).join('');
    },
    
    populateSelectedGalleries() {
        const container = document.getElementById('selected-galleries');
        if (!container || !this.allSections) return;
        
        // Get selected sections in order
        const selectedSections = [];
        if (this.selectedSections && this.selectedSections.length > 0) {
            this.selectedSections.forEach(sectionId => {
                const section = this.allSections?.find(s => s.id === sectionId);
                if (section) {
                    selectedSections.push(section);
                }
            });
        }
        
        if (selectedSections.length === 0) {
            container.innerHTML = `
                <div class="drag-panel-empty">
                    <i class="fas fa-arrow-left fa-2x mb-2"></i>
                    <p>Drag galleries from Available to here</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = selectedSections.map(section => 
            this.renderGalleryItem(section, true)
        ).join('');
    },
    
    renderGalleryItem(section, isSelected) {
        const layoutColor = {
            'grid': 'primary',
            'masonry': 'purple', 
            'carousel': 'warning',
            'slideshow': 'info'
        }[section.layout_type] || 'secondary';
        
        return `
            <div class="gallery-item" draggable="true" data-section-id="${section.id}">
                <div class="gallery-item-handle">
                    <i class="fas fa-grip-vertical"></i>
                </div>
                ${isSelected ? `<button class="gallery-item-remove" onclick="GalleryPageEditor.removeSection(${section.id})"><i class="fas fa-times"></i></button>` : ''}
                <div class="gallery-item-content">
                    <div class="gallery-item-title">${section.section_name}</div>
                    <div class="gallery-item-meta">
                        <span class="gallery-item-layout bg-${layoutColor} text-white">${section.layout_type}</span>
                        <span>${section.media_count || 0} images</span>
                    </div>
                </div>
            </div>
        `;
    },
    
    isSectionSelected(sectionId) {
        return this.selectedSections && this.selectedSections.includes(sectionId);
    },
    
    initializeDragAndDrop() {
        this.setupDragEvents();
    },
    
    setupDragEvents() {
        // Add event listeners for drag and drop
        const availableContainer = document.getElementById('available-galleries');
        const selectedContainer = document.getElementById('selected-galleries');
        
        if (availableContainer) {
            this.setupDropZone(availableContainer, 'available');
        }
        
        if (selectedContainer) {
            this.setupDropZone(selectedContainer, 'selected');
        }
    },
    
    setupDropZone(container, type) {
        // Drag start event
        container.addEventListener('dragstart', (e) => {
            if (e.target.classList.contains('gallery-item')) {
                e.target.classList.add('dragging');
                e.dataTransfer.setData('text/plain', e.target.dataset.sectionId);
                e.dataTransfer.setData('source', type);
            }
        });
        
        // Drag end event
        container.addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
        });
        
        // Drop events
        container.addEventListener('dragover', (e) => {
            e.preventDefault();
            container.parentNode.classList.add('drag-over');
        });
        
        container.addEventListener('dragleave', (e) => {
            container.parentNode.classList.remove('drag-over');
        });
        
        container.addEventListener('drop', (e) => {
            e.preventDefault();
            container.parentNode.classList.remove('drag-over');
            
            const sectionId = parseInt(e.dataTransfer.getData('text/plain'));
            const sourceType = e.dataTransfer.getData('source');
            
            if (type === 'selected' && sourceType === 'available') {
                this.addSection(sectionId);
            } else if (type === 'available' && sourceType === 'selected') {
                this.removeSection(sectionId);
            } else if (type === 'selected' && sourceType === 'selected') {
                this.reorderSection(sectionId, e);
            }
        });
    },
    
    async addSection(sectionId) {
        if (!this.selectedSections.includes(sectionId)) {
            this.selectedSections.push(sectionId);
            await this.saveSelectedSections();
            this.renderDragAndDropInterface();
        }
    },
    
    async removeSection(sectionId) {
        const index = this.selectedSections.indexOf(sectionId);
        if (index > -1) {
            this.selectedSections.splice(index, 1);
            await this.saveSelectedSections();
            this.renderDragAndDropInterface();
        }
    },
    
    async reorderSection(sectionId, dropEvent) {
        const items = Array.from(dropEvent.target.closest('.drag-panel-body').querySelectorAll('.gallery-item'));
        const targetItem = dropEvent.target.closest('.gallery-item');
        
        if (targetItem) {
            const targetIndex = items.indexOf(targetItem);
            const currentIndex = this.selectedSections.indexOf(sectionId);
            
            if (currentIndex > -1 && targetIndex >= 0) {
                // Remove from current position
                this.selectedSections.splice(currentIndex, 1);
                // Insert at new position
                this.selectedSections.splice(targetIndex, 0, sectionId);
                
                await this.saveSelectedSections();
                this.renderDragAndDropInterface();
            }
        }
    },
    
    async saveSelectedSections() {
        try {
            const response = await fetch(`/api/model-content-new/${this.currentModelSlug}/gallery`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    selected_sections: JSON.stringify(this.selectedSections)
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to save selected sections');
            }
            
        } catch (error) {
            console.error('Error saving selected sections:', error);
        }
    },
    
    showGallerySectionsError() {
        const availableContainer = document.getElementById('available-galleries');
        const selectedContainer = document.getElementById('selected-galleries');
        
        const errorHtml = `
            <div class="text-center py-4 text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>Error loading gallery sections</p>
                <button class="btn btn-outline-danger btn-sm" onclick="GalleryPageEditor.loadGallerySections()">
                    <i class="fas fa-redo me-1"></i>Retry
                </button>
            </div>
        `;
        
        if (availableContainer) availableContainer.innerHTML = errorHtml;
        if (selectedContainer) selectedContainer.innerHTML = errorHtml;
    },
    
    async resetToDefaults() {
        if (confirm('Reset gallery content selection to defaults? This will clear all selected galleries.')) {
            this.selectedSections = [];
            await this.saveSelectedSections();
            this.renderDragAndDropInterface();
        }
    },
    
    selectHeroImage() {
        // This would typically open an image selector modal
        // For now, we'll use a simple prompt as a placeholder
        alert('Hero image selector functionality would be implemented here. This would open a modal to select from gallery images.');
    },
    
    clearHeroImage() {
        const imageField = document.getElementById('hero_background_image_id');
        if (imageField) {
            imageField.value = '';
            this.autoSave(imageField);
            this.updateHeroImagePreview();
        }
    },
    
    updateHeroBackgroundPreview() {
        const backgroundSelect = document.getElementById('hero_background_image_id');
        const preview = document.getElementById('hero-background-preview');
        const previewImg = document.getElementById('hero-background-preview-img');
        
        if (backgroundSelect.value && backgroundSelect.selectedOptions[0]) {
            // Get filename from the selected option text
            const selectedText = backgroundSelect.selectedOptions[0].textContent;
            const filename = selectedText.split(' (')[0]; // Extract filename
            
            // Show preview with actual image - use the correct gallery path
            preview.classList.remove('d-none');
            previewImg.src = `/uploads/${this.currentModelSlug}/public/gallery/${filename}`;
            
            console.log(`Hero background image set to: ${filename}`);
        } else {
            preview.classList.add('d-none');
        }
    }
};

// Initialize when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
    GalleryPageEditor.init();
    
    // Initialize Bootstrap tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>