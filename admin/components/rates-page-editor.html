<!-- Rates Page Content Editor - Database-Aligned -->
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-2 text-gray-800">
                        <i class="fas fa-dollar-sign text-success me-2"></i>
                        Rates Page Content Editor
                    </h1>
                    <p class="text-muted mb-0">Configure your pricing and booking policies</p>
                </div>
                <div class="d-flex gap-2">
                    <div class="form-check form-switch">
                        <input class="form-check-input auto-save-field" type="checkbox" id="page_published" data-field="page_published">
                        <label class="form-check-label fw-bold text-warning" for="page_published" id="publish-label">
                            <i class="fas fa-eye-slash me-1"></i>Draft
                        </label>
                    </div>
                    <a href="#" onclick="window.history.back()" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Content Hub
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Auto-save Status -->
    <div id="auto-save-status" class="alert alert-info d-none">
        <i class="fas fa-spinner fa-spin me-2"></i>
        <span id="save-status-text">Saving...</span>
    </div>

    <!-- Header + Tables Section -->
    <div class="card shadow-sm">
        <div class="card-header bg-gradient-success text-white">
            <h4 class="mb-0">
                <i class="fas fa-tags me-2"></i>Pricing & Policies
            </h4>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <!-- Navigation Labels -->
                <div class="col-12 col-xl-8">
                    <div class="bg-light rounded p-3 mb-4">
                        <h5 class="text-info mb-3"><i class="fas fa-compass me-2"></i>Sticky Navigation Labels</h5>
                        <div class="row g-2">
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm auto-save-input" data-field="nav_rates_label" placeholder="Rates" id="nav_rates_label">
                                <small class="text-muted">Rates</small>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm auto-save-input" data-field="nav_extended_label" placeholder="Extended" id="nav_extended_label">
                                <small class="text-muted">Extended</small>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm auto-save-input" data-field="nav_services_label" placeholder="Services" id="nav_services_label">
                                <small class="text-muted">Services</small>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm auto-save-input" data-field="nav_policies_label" placeholder="Policies" id="nav_policies_label">
                                <small class="text-muted">Policies</small>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm auto-save-input" data-field="nav_payment_label" placeholder="Payment" id="nav_payment_label">
                                <small class="text-muted">Payment</small>
                            </div>
                            <div class="col-md-2">
                                <input type="text" class="form-control form-control-sm auto-save-input" data-field="nav_contact_label" placeholder="Contact" id="nav_contact_label">
                                <small class="text-muted">Contact</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Page Header (stored in content_templates page_type 5) -->
                <div class="col-12 col-xl-4">
                    <div class="bg-light rounded p-3 h-100">
                        <h5 class="text-success mb-3"><i class="fas fa-heading me-2"></i>Page Header</h5>
                        <div class="enhanced-field mb-3">
                            <label class="form-label fw-bold">Page Title</label>
                            <input type="text" class="form-control ct-field" data-ct-key="page_title" placeholder="Rates & Investment">
                            <div class="save-status mt-1" data-ct-status="page_title"></div>
                        </div>
                        <div class="enhanced-field mb-3">
                            <label class="form-label fw-bold">Introduction Text</label>
                            <textarea class="form-control ct-field" data-ct-key="rates_intro" rows="4" placeholder="Intro paragraph"></textarea>
                            <div class="save-status mt-1" data-ct-status="rates_intro"></div>
                        </div>
                        <div class="alert alert-secondary small mb-0">Header fields autosave. Rates/terms are managed in the tables.</div>
                    </div>
                </div>
                
                <!-- Incall Rates Table -->
                <div class="col-12 col-xl-8">
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0 text-primary"><i class="fas fa-building me-2"></i>Incall Rates</h5>
                            <div class="d-flex gap-2">
                                <input class="form-control form-control-sm" placeholder="Service" id="incall_service">
                                <input class="form-control form-control-sm" placeholder="Duration" id="incall_duration">
                                <input class="form-control form-control-sm" placeholder="Price" id="incall_price">
                                <button class="btn btn-sm btn-primary" id="add_incall">Add</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle" id="table_incall">
                                <thead><tr><th>Service</th><th>Duration</th><th>Price</th><th>Visible</th><th>Order</th><th>Most Popular</th><th></th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Outcall -->
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0 text-primary"><i class="fas fa-car-side me-2"></i>Outcall Rates</h5>
                            <div class="d-flex gap-2">
                                <input class="form-control form-control-sm" placeholder="Service" id="outcall_service">
                                <input class="form-control form-control-sm" placeholder="Duration" id="outcall_duration">
                                <input class="form-control form-control-sm" placeholder="Price" id="outcall_price">
                                <button class="btn btn-sm btn-primary" id="add_outcall">Add</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle" id="table_outcall">
                                <thead><tr><th>Service</th><th>Duration</th><th>Price</th><th>Visible</th><th>Order</th><th>Most Popular</th><th></th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Extended -->
                    <div class="border rounded p-3 mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="mb-0 text-primary"><i class="fas fa-hourglass-half me-2"></i>Extended Engagements</h5>
                            <div class="d-flex gap-2">
                                <input class="form-control form-control-sm" placeholder="Service" id="extended_service">
                                <input class="form-control form-control-sm" placeholder="Duration" id="extended_duration">
                                <input class="form-control form-control-sm" placeholder="Price" id="extended_price">
                                <button class="btn btn-sm btn-primary" id="add_extended">Add</button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm align-middle" id="table_extended">
                                <thead><tr><th>Service</th><th>Duration</th><th>Price</th><th>Visible</th><th>Order</th><th>Most Popular</th><th></th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Terms -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="border rounded p-3 h-100">
                                <h5 class="mb-3 text-warning"><i class="fas fa-credit-card me-2"></i>Payment & Booking</h5>
                                
                                <!-- Payment Terms -->
                                <div class="mb-3">
                                    <label class="form-label text-primary fw-bold">Payment Terms</label>
                                    <textarea class="form-control auto-save-input" rows="3" 
                                              data-field="payment_terms" 
                                              placeholder="e.g., Cash accepted ‚Ä¢ Payment due at start ‚Ä¢ Credit cards +3% fee"
                                              id="payment_terms"></textarea>
                                    <small class="form-text text-muted">Separate terms with " ‚Ä¢ " (bullet point space)</small>
                                </div>
                                
                                <!-- Booking Policies -->
                                <div class="mb-3">
                                    <label class="form-label text-success fw-bold">Booking Policies</label>
                                    <textarea class="form-control auto-save-input" rows="3" 
                                              data-field="booking_policies" 
                                              placeholder="e.g., Advance booking recommended ‚Ä¢ Same day +$100 ‚Ä¢ 24hr cancellation"
                                              id="booking_policies"></textarea>
                                    <small class="form-text text-muted">Separate policies with " ‚Ä¢ " (bullet point space)</small>
                                </div>
                                
                                <!-- Additional Services -->
                                <div class="mb-0">
                                    <label class="form-label text-purple fw-bold">Additional Services</label>
                                    <textarea class="form-control auto-save-input" rows="3" 
                                              data-field="additional_services" 
                                              placeholder="e.g., Dinner dates +$100 ‚Ä¢ Travel +$500/day ‚Ä¢ Late night +$150"
                                              id="additional_services"></textarea>
                                    <small class="form-text text-muted">Separate services with " ‚Ä¢ " (bullet point space)</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="border rounded p-3 h-100">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0 text-secondary"><i class="fas fa-plus me-2"></i>Additional Services</h5>
                                    <div class="input-group input-group-sm" style="max-width: 380px;">
                                        <input class="form-control" placeholder="Add term" id="additional_term_text">
                                        <button class="btn btn-secondary" id="add_additional_term">Add</button>
                                    </div>
                                </div>
                                <ul class="list-group list-group-flush small" id="list_additional"></ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Advanced Customization Section -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="fas fa-palette me-2"></i>Advanced Page Customization
            </h4>
            <button class="btn btn-outline-light btn-sm" id="resetCustomizationBtn" title="Reset all customizations to template defaults">
                <i class="fas fa-undo me-1"></i>Reset to Defaults
            </button>
        </div>
        <div class="card-body">
            <div class="row g-4">
                
                <!-- Hero Section Customization -->
                <div class="col-lg-6">
                    <div class="bg-light rounded p-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-heading me-2"></i>Hero Section
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Subtitle Size</label>
                                <select class="form-select form-select-sm auto-save-input" 
                                        data-field="hero_subtitle_size" 
                                        data-page-content="true"
                                        id="hero_subtitle_size">
                                    <option value="small">Small</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Subtitle Color</label>
                                <input type="color" class="form-control form-control-sm auto-save-input" 
                                       data-field="hero_subtitle_color" 
                                       data-page-content="true"
                                       id="hero_subtitle_color" 
                                       value="#FFFFFF">
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input auto-save-input" 
                                           type="checkbox" 
                                           data-field="hero_divider_visible" 
                                           data-page-content="true"
                                           id="hero_divider_visible">
                                    <label class="form-check-label fw-bold" for="hero_divider_visible">
                                        Show Divider
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select form-select-sm auto-save-input" 
                                        data-field="hero_divider_type" 
                                        data-page-content="true"
                                        id="hero_divider_type">
                                    <option value="line">Line</option>
                                    <option value="icon">Icon</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Rates Section Customization -->
                <div class="col-lg-6">
                    <div class="bg-light rounded p-4">
                        <h5 class="text-success mb-3">
                            <i class="fas fa-table me-2"></i>Rates Section
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input auto-save-input" 
                                           type="checkbox" 
                                           data-field="rates_highlight_badge_visible" 
                                           data-page-content="true"
                                           id="rates_highlight_badge_visible">
                                    <label class="form-check-label fw-bold" for="rates_highlight_badge_visible">
                                        Show Highlight Badges
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <input type="text" 
                                       class="form-control form-control-sm auto-save-input" 
                                       data-field="rates_highlight_badge_text" 
                                       data-page-content="true"
                                       id="rates_highlight_badge_text" 
                                       placeholder="Most Popular">
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input auto-save-input" 
                                           type="checkbox" 
                                           data-field="rates_background_tint_visible" 
                                           data-page-content="true"
                                           id="rates_background_tint_visible">
                                    <label class="form-check-label fw-bold" for="rates_background_tint_visible">
                                        Background Tint
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <input type="color" class="form-control form-control-sm auto-save-input" 
                                       data-field="rates_background_tint_color" 
                                       data-page-content="true"
                                       id="rates_background_tint_color" 
                                       value="#F8F9FA">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Extended Engagements Customization -->
                <div class="col-lg-6">
                    <div class="bg-light rounded p-4">
                        <h5 class="text-info mb-3">
                            <i class="fas fa-hourglass-half me-2"></i>Extended Engagements
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input auto-save-input" 
                                           type="checkbox" 
                                           data-field="extended_icon_visible" 
                                           data-page-content="true"
                                           id="extended_icon_visible" 
                                           checked>
                                    <label class="form-check-label fw-bold" for="extended_icon_visible">
                                        Show Icons
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <select class="form-select form-select-sm auto-save-input" 
                                        data-field="extended_color_saturation" 
                                        data-page-content="true"
                                        id="extended_color_saturation">
                                    <option value="low">Low Saturation</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High Saturation</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row g-3 mt-2">
                            <div class="col-md-12">
                                <div class="form-check">
                                    <input class="form-check-input auto-save-input" 
                                           type="checkbox" 
                                           data-field="extended_description_visible" 
                                           data-page-content="true"
                                           id="extended_description_visible">
                                    <label class="form-check-label fw-bold" for="extended_description_visible">
                                        Show Descriptions
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Footer Customization -->
                <div class="col-lg-6">
                    <div class="bg-light rounded p-4">
                        <h5 class="text-secondary mb-3">
                            <i class="fas fa-align-center me-2"></i>Footer Section
                        </h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Footer Title</label>
                            <input type="text" class="form-control form-control-sm auto-save-input" 
                                   data-field="footer_title" 
                                   data-page-content="true"
                                   id="footer_title" 
                                   placeholder="Use model name if empty">
                        </div>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input auto-save-input" 
                                           type="checkbox" 
                                           data-field="footer_border_visible" 
                                           data-page-content="true"
                                           id="footer_border_visible">
                                    <label class="form-check-label fw-bold" for="footer_border_visible">
                                        Top Border
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input auto-save-input" 
                                           type="checkbox" 
                                           data-field="footer_padding_enhanced" 
                                           data-page-content="true"
                                           id="footer_padding_enhanced" 
                                           checked>
                                    <label class="form-check-label fw-bold" for="footer_padding_enhanced">
                                        Enhanced Padding
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- Call to Action Section -->
    <div class="card shadow-sm mt-4">
        <div class="card-header bg-gradient-danger text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-bullhorn me-2"></i>Call to Action
                </h4>
                <div class="form-check form-switch">
                    <input class="form-check-input auto-save-input" type="checkbox" id="cta_visible" data-field="cta_visible" checked>
                    <label class="form-check-label text-white" for="cta_visible">Visible</label>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-4">
                <!-- CTA Content -->
                <div class="col-lg-6">
                    <div class="bg-light rounded p-4">
                        <h5 class="text-danger mb-3">
                            <i class="fas fa-file-text me-2"></i>Content
                        </h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Section Title</label>
                            <input type="text" class="form-control auto-save-input" 
                                   id="cta_title" 
                                   data-field="cta_title"
                                   placeholder="Ready to Book?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Section Description</label>
                            <textarea class="form-control auto-save-input" 
                                      id="cta_description" 
                                      data-field="cta_description"
                                      rows="3"
                                      placeholder="Contact me to discuss your preferences and arrange our time together."></textarea>
                        </div>
                        
                        <div class="mb-0">
                            <label class="form-label fw-bold">Secondary Text <small class="text-muted">(Optional)</small></label>
                            <textarea class="form-control auto-save-input" 
                                      id="cta_secondary_text" 
                                      data-field="cta_secondary_text"
                                      rows="2"
                                      placeholder="Contact me with questions or special requests"></textarea>
                        </div>
                    </div>
                </div>
                
                <!-- CTA Buttons -->
                <div class="col-lg-6">
                    <div class="bg-light rounded p-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-click me-2"></i>Action Buttons
                        </h5>
                        
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white py-2">
                                        <small class="fw-bold">Primary CTA Button</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm auto-save-input" 
                                                   id="cta_button_1_text" 
                                                   data-field="cta_button_1_text"
                                                   placeholder="Contact Me">
                                        </div>
                                        <div class="mb-0">
                                            <select class="form-select form-select-sm auto-save-input" 
                                                    id="cta_button_1_link" 
                                                    data-field="cta_button_1_link">
                                                <option value="contact">‚úâÔ∏è Contact Page</option>
                                                <option value="calendar">üìÖ Calendar Page</option>
                                                <option value="rates">üí∞ Rates Page</option>
                                                <option value="about">üë§ About Page</option>
                                                <option value="gallery">üñºÔ∏è Gallery Page</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="card border-secondary">
                                    <div class="card-header bg-secondary text-white py-2">
                                        <small class="fw-bold">Secondary CTA Button</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm auto-save-input" 
                                                   id="cta_button_2_text" 
                                                   data-field="cta_button_2_text"
                                                   placeholder="View Calendar">
                                        </div>
                                        <div class="mb-0">
                                            <select class="form-select form-select-sm auto-save-input" 
                                                    id="cta_button_2_link" 
                                                    data-field="cta_button_2_link">
                                                <option value="calendar">üìÖ Calendar Page</option>
                                                <option value="contact">‚úâÔ∏è Contact Page</option>
                                                <option value="gallery">üñºÔ∏è Gallery Page</option>
                                                <option value="rates">üí∞ Rates Page</option>
                                                <option value="about">üë§ About Page</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom CSS -->
<style>
.bg-gradient-success {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.bg-gradient-danger {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.enhanced-field {
    position: relative;
}

.save-status {
    min-height: 1.2rem;
    font-size: 0.75rem;
}

.save-status.saving {
    color: #007bff;
}

.save-status.saved {
    color: #28a745;
}

.save-status.error {
    color: #dc3545;
}

.auto-save-field:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const ratesPageEditor = {
        currentModelSlug: null,
        saveTimeout: null,
        isLoading: false,
        data: { incall: [], outcall: [], extended: [], payment: [], additional: [] },
        
        init() {
            this.extractModelSlug();
            this.loadHeader();
            this.loadTables();
            this.loadAdvancedCustomizations();
            this.bindHeaderAutosave();
            this.bindPaymentBookingAutosave();
            this.bindAdvancedCustomizationAutosave();
        },
        
        extractModelSlug() {
            const pathParts = window.location.pathname.split('/');
            this.currentModelSlug = pathParts[1];
            console.log('Editing rates page for model:', this.currentModelSlug);
        },
        
        async loadHeader() {
            this.showLoading();
            
            try {
                const response = await fetch(`/api/model-content/${this.currentModelSlug}/pages/5`);
                const data = await response.json();
                const items = (data && (data.items || (data.data && data.data.items))) || [];
                const content = {};
                items.forEach(i => content[i.content_key] = i.content_value);
                this.populateHeader(content);
            } catch (error) {
                console.error('Error loading rates page content:', error);
                this.showError('Failed to load content');
            } finally {
                this.hideLoading();
            }
        },
        async loadTables(){
            try{
                const r = await fetch(`/api/model-rates/${this.currentModelSlug}`);
                const d = await r.json();
                if (d.success){
                    this.data = d.data;
                    this.renderTables();
                }
            }catch(e){ console.error('Failed to load rates tables', e); }
        },
        
        populateHeader(content) {
            for (const [field, value] of Object.entries(content)) {
                const element = document.querySelector(`[data-ct-key="${field}"]`) || document.getElementById(field);
                if (element) {
                    if (element.type === 'checkbox') {
                        const isChecked = value === true || value === 1 || value === '1';
                        element.checked = isChecked;
                        
                        if (field === 'page_published') {
                            this.updatePublishStatus(isChecked);
                        }
                    } else {
                        element.value = value || '';
                    }
                }
            }
        },
        
        async loadAdvancedCustomizations() {
            try {
                // First check if we have any customizations in the database
                const response = await fetch(`/api/model-rates/${this.currentModelSlug}`);
                const result = await response.json();
                
                if (result.success) {
                    // Load current customization values from database
                    const customizationResponse = await fetch(`/api/model-rates/${this.currentModelSlug}/page-content`);
                    
                    if (customizationResponse.ok) {
                        const customizationResult = await customizationResponse.json();
                        
                        if (customizationResult.success && customizationResult.data) {
                            const data = customizationResult.data;
                            
                            // Populate form fields with current values
                            Object.entries(data).forEach(([key, value]) => {
                                const field = document.querySelector(`[data-field="${key}"]`);
                                if (field) {
                                    if (field.type === 'checkbox') {
                                        field.checked = !!value;
                                    } else {
                                        field.value = value || '';
                                    }
                                }
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading advanced customizations:', error);
            }
        },
        
        bindHeaderAutosave() {
            const fields = document.querySelectorAll('.ct-field');
            fields.forEach(field => {
                const key = field.dataset.ctKey;
                const statusEl = document.querySelector(`[data-ct-status="${key}"]`);
                const save = async () => {
                    if (statusEl){ statusEl.textContent = 'Saving...'; statusEl.className = 'save-status saving'; }
                    const value = field.value;
                    await fetch(`/api/model-content/${this.currentModelSlug}/pages/5/${encodeURIComponent(key)}`, {
                        method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content_value: value })
                    }).then(r=>r.json()).then(d => {
                        if (statusEl){ statusEl.textContent = d.success ? 'Saved' : 'Error'; statusEl.className = 'save-status ' + (d.success ? 'saved':'error'); }
                    }).catch(()=>{ if (statusEl){ statusEl.textContent = 'Error'; statusEl.className = 'save-status error'; }});
                };
                field.addEventListener('input', () => { clearTimeout(this.saveTimeout); this.saveTimeout = setTimeout(save, 800); });
                field.addEventListener('change', save);
            });
            
            // Bind publish toggle auto-save
            const publishToggle = document.getElementById('page_published');
            if (publishToggle) {
                const savePublish = async () => {
                    const value = publishToggle.checked ? 1 : 0;
                    this.updatePublishStatus(publishToggle.checked);
                    await fetch(`/api/model-content/${this.currentModelSlug}/pages/5/page_published`, {
                        method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content_value: value })
                    });
                };
                publishToggle.addEventListener('change', savePublish);
            }
        },
        
        bindPaymentBookingAutosave() {
            // Handle payment/booking fields (save to content_templates)
            const contentFields = document.querySelectorAll('.auto-save-input:not([data-page-content])');
            contentFields.forEach(field => {
                const key = field.dataset.field;
                const save = async () => {
                    const value = field.value;
                    try {
                        await fetch(`/api/model-content/${this.currentModelSlug}/pages/5/${encodeURIComponent(key)}`, {
                            method: 'PUT', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ content_value: value })
                        });
                        console.log(`Saved ${key}:`, value);
                    } catch (error) {
                        console.error(`Error saving ${key}:`, error);
                    }
                };
                field.addEventListener('input', () => { 
                    clearTimeout(this.saveTimeout); 
                    this.saveTimeout = setTimeout(save, 1500); 
                });
                field.addEventListener('change', save);
            });
        },
        
        bindAdvancedCustomizationAutosave() {
            // Handle Advanced Page Customization fields (save to model_rates_page_content)
            const customizationFields = document.querySelectorAll('.auto-save-input[data-page-content]');
            console.log(`üéõÔ∏è Found ${customizationFields.length} Advanced Customization fields:`, Array.from(customizationFields).map(f => f.dataset.field));
            customizationFields.forEach(field => {
                const key = field.dataset.field;
                const save = async () => {
                    let value;
                    if (field.type === 'checkbox') {
                        value = field.checked ? 1 : 0;
                    } else {
                        value = field.value;
                    }
                    
                    console.log(`üîÑ Auto-saving ${key}:`, value);
                    
                    try {
                        const response = await fetch(`/api/model-rates/${this.currentModelSlug}/page-content/${encodeURIComponent(key)}`, {
                            method: 'PUT', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ content_value: value })
                        });
                        const result = await response.json();
                        console.log(`‚úÖ Saved customization ${key}:`, value, result);
                    } catch (error) {
                        console.error(`‚ùå Error saving customization ${key}:`, error);
                    }
                };
                field.addEventListener('input', () => { 
                    clearTimeout(this.saveTimeout); 
                    this.saveTimeout = setTimeout(save, 1500); 
                });
                field.addEventListener('change', save);
            });
            
            // Bind reset button
            const resetBtn = document.getElementById('resetCustomizationBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', () => this.resetToDefaults());
            }
        },
        
        async resetToDefaults() {
            if (!confirm('Are you sure you want to reset all Advanced Page Customizations to template defaults? This cannot be undone.')) {
                return;
            }
            
            console.log('üîÑ Loading original template defaults...');
            
            // Load original template defaults from content_templates table
            let defaults = {};
            try {
                const templateResponse = await fetch(`/api/model-content/${this.currentModelSlug}/pages/5`);
                const templateResult = await templateResponse.json();
                
                if (templateResult.success && templateResult.data && templateResult.data.items) {
                    const templateItems = templateResult.data.items;
                    
                    // Convert items array to object for easier lookup
                    const templateData = {};
                    templateItems.forEach(item => {
                        templateData[item.content_key] = item.content_value;
                    });
                    
                    // Map template values to rates page content format
                    defaults = {
                        hero_subtitle_size: templateData.hero_subtitle_size || 'medium',
                        hero_subtitle_color: templateData.hero_subtitle_color || '#FFFFFF',
                        hero_divider_visible: (templateData.hero_divider_visible === 'on' || templateData.hero_divider_visible === '1') ? 1 : 0,
                        hero_divider_type: templateData.hero_divider_type || 'line',
                        rates_highlight_badge_visible: 0,
                        rates_highlight_badge_text: 'Most Popular',
                        rates_background_tint_visible: 0,
                        rates_background_tint_color: '#F8F9FA',
                        extended_icon_visible: 1,
                        extended_color_saturation: 'medium',
                        extended_description_visible: 0,
                        footer_border_visible: 0,
                        footer_padding_enhanced: 0,
                        footer_title: '',
                        footer_description: '',
                        footer_copyright: ''
                    };
                    
                    console.log('‚úÖ Loaded template defaults:', defaults);
                } else {
                    throw new Error('Failed to load template defaults');
                }
            } catch (error) {
                console.error('‚ùå Error loading template defaults, using fallback:', error);
                // Fallback to database schema defaults
                defaults = {
                    hero_subtitle_size: 'medium',
                    hero_subtitle_color: '#FFFFFF',
                    hero_divider_visible: 0,
                    hero_divider_type: 'line',
                    rates_highlight_badge_visible: 0,
                    rates_highlight_badge_text: 'Most Popular',
                    rates_background_tint_visible: 0,
                    rates_background_tint_color: '#F8F9FA',
                    extended_icon_visible: 1,
                    extended_color_saturation: 'medium',
                    extended_description_visible: 0,
                    footer_border_visible: 0,
                    footer_padding_enhanced: 0,
                    footer_title: '',
                    footer_description: '',
                    footer_copyright: ''
                };
            }
            
            try {
                console.log('üîÑ Resetting to template defaults...');
                
                // Use the new reset API endpoint
                const resetResponse = await fetch(`/api/model-rates/${this.currentModelSlug}/page-content/reset`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const resetResult = await resetResponse.json();
                
                if (resetResult.success) {
                    const resetValues = resetResult.data.values;
                    console.log('‚úÖ Reset successful, updating form fields:', resetValues);
                    
                    // Update form fields to reflect the reset values
                    Object.entries(resetValues).forEach(([key, value]) => {
                        const field = document.querySelector(`[data-field="${key}"]`);
                        if (field) {
                            if (field.type === 'checkbox') {
                                field.checked = !!value;
                            } else {
                                field.value = value;
                            }
                            console.log(`‚úÖ Updated field ${key} to:`, field.type === 'checkbox' ? field.checked : field.value);
                        } else {
                            console.log(`‚ö†Ô∏è Field not found: ${key}`);
                        }
                    });
                    
                    alert('Hero Section has been reset to original template defaults!');
                } else {
                    throw new Error(resetResult.message || 'Reset failed');
                }
                
            } catch (error) {
                console.error('‚ùå Error resetting to defaults:', error);
                alert('Failed to reset customizations. Please try again.');
            }
        },
        
        updatePublishStatus(isPublished) {
            const label = document.getElementById('publish-label');
            if (label) {
                if (isPublished) {
                    label.innerHTML = '<i class="fas fa-eye me-1"></i>Published';
                    label.className = 'form-check-label fw-bold text-success';
                } else {
                    label.innerHTML = '<i class="fas fa-eye-slash me-1"></i>Draft';
                    label.className = 'form-check-label fw-bold text-warning';
                }
            }
        },
        
        scheduleAutoSave(field) {
            const fieldName = field.dataset.field;
            const statusElement = field.closest('.enhanced-field')?.querySelector('.save-status');
            
            if (statusElement) {
                statusElement.textContent = 'Editing...';
                statusElement.className = 'save-status saving';
            }
            
            if (this.saveTimeout) {
                clearTimeout(this.saveTimeout);
            }
            
            this.saveTimeout = setTimeout(() => {
                this.saveField(field);
            }, 1500);
        },
        
        async saveField(field) {
            const fieldName = field.dataset.field;
            const statusElement = field.closest('.enhanced-field')?.querySelector('.save-status');
            let value;
            
            if (field.type === 'checkbox') {
                value = field.checked ? 1 : 0;
            } else {
                value = field.value;
            }
            
            if (statusElement) {
                statusElement.textContent = 'Saving...';
                statusElement.className = 'save-status saving';
            }
            
            try {
                const response = await fetch(`/api/model-rates/${this.currentModelSlug}/${field.dataset.action}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(value)
                });
                const result = await response.json();
                if (result.success) {
                    if (statusElement) {
                        statusElement.textContent = 'Saved';
                        statusElement.className = 'save-status saved';
                        
                        setTimeout(() => {
                            statusElement.textContent = '';
                            statusElement.className = 'save-status';
                        }, 3000);
                    }
                } else {
                    throw new Error(result.message || 'Save failed');
                }
                
            } catch (error) {
                console.error('Save error:', error);
                
                if (statusElement) {
                    statusElement.textContent = 'Save failed';
                    statusElement.className = 'save-status error';
                }
            }
        },

        renderTables(){
            const fill = (tbodyId, list, type) => {
                const tbody = document.querySelector(`#${tbodyId} tbody`);
                tbody.innerHTML = (list||[]).map(r => `
                  <tr data-id="${r.id}">
                    <td><input class="form-control form-control-sm rate-input" data-field="service_name" value="${r.service_name||''}"></td>
                    <td><input class="form-control form-control-sm rate-input" data-field="duration" value="${r.duration||''}"></td>
                    <td><input class="form-control form-control-sm rate-input" data-field="price" value="${r.price||''}"></td>
                    <td><input type="checkbox" class="form-check-input rate-input" data-field="is_visible" ${r.is_visible? 'checked':''}></td>
                    <td style="width:90px"><input type="number" class="form-control form-control-sm rate-input" data-field="sort_order" value="${r.sort_order||0}"></td>
                    <td class="text-center"><input type="radio" class="form-check-input most-popular-radio" name="most_popular_${type}" data-rate-id="${r.id}" ${r.is_most_popular? 'checked':''}></td>
                    <td class="text-end"><button class="btn btn-sm btn-outline-danger btn-del">Delete</button></td>
                  </tr>`).join('');
                // bind change
                tbody.querySelectorAll('.rate-input').forEach(input => {
                    input.addEventListener('change', async (e) => {
                        const tr = input.closest('tr');
                        const id = tr.dataset.id;
                        const field = input.dataset.field;
                        const val = input.type === 'checkbox' ? (input.checked ? 1 : 0) : input.value;
                        await fetch(`/api/model-rates/${this.currentModelSlug}/rate/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ [field]: val })});
                    });
                });
                tbody.querySelectorAll('.btn-del').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const tr = btn.closest('tr');
                        const id = tr.dataset.id;
                        await fetch(`/api/model-rates/${this.currentModelSlug}/rate/${id}`, { method: 'DELETE' });
                        tr.remove();
                    });
                });
                // bind most popular radio buttons
                tbody.querySelectorAll('.most-popular-radio').forEach(radio => {
                    radio.addEventListener('change', async () => {
                        if (radio.checked) {
                            const rateId = radio.dataset.rateId;
                            console.log(`üåü Setting rate ${rateId} as most popular`);
                            
                            // First, unset all other rates in this type as not most popular
                            const allRadios = document.querySelectorAll(`input[name="${radio.name}"]`);
                            for (const otherRadio of allRadios) {
                                if (otherRadio !== radio) {
                                    const otherRateId = otherRadio.dataset.rateId;
                                    await fetch(`/api/model-rates/${this.currentModelSlug}/rate/${otherRateId}`, {
                                        method: 'PUT',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ 
                                            is_most_popular: 0,
                                            highlight_badge: 0,
                                            highlight_badge_text: null
                                        })
                                    });
                                }
                            }
                            
                            // Then set this rate as most popular
                            await fetch(`/api/model-rates/${this.currentModelSlug}/rate/${rateId}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ 
                                    is_most_popular: 1,
                                    highlight_badge: 1,
                                    highlight_badge_text: 'Most Popular'
                                })
                            });
                            
                            console.log(`‚úÖ Successfully set rate ${rateId} as most popular`);
                        }
                    });
                });
            };
            fill('table_incall', this.data.incall, 'incall');
            fill('table_outcall', this.data.outcall, 'outcall');
            fill('table_extended', this.data.extended, 'extended');

            const fillTerms = (ulId, terms, category) => {
                const ul = document.getElementById(ulId);
                ul.innerHTML = (terms||[]).map(t => `
                  <li class="list-group-item d-flex align-items-center justify-content-between" data-id="${t.id}">
                    <input class="form-control form-control-sm me-2 term-input" value="${t.term_text}" style="flex:1">
                    <input type="number" class="form-control form-control-sm me-2 term-input" data-field="sort_order" value="${t.sort_order||0}" style="width:90px">
                    <div class="form-check form-switch me-2"><input class="form-check-input term-input" type="checkbox" data-field="is_visible" ${t.is_visible? 'checked':''}></div>
                    <button class="btn btn-sm btn-outline-danger btn-del-term">Delete</button>
                  </li>`).join('');
                ul.querySelectorAll('.term-input').forEach(input => {
                    input.addEventListener('change', async () => {
                        const li = input.closest('li');
                        const id = li.dataset.id;
                        const field = input.dataset.field || 'term_text';
                        const val = input.type === 'checkbox' ? (input.checked ? 1 : 0) : input.value;
                        await fetch(`/api/model-rates/${this.currentModelSlug}/term/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ [field]: val })});
                    });
                });
                ul.querySelectorAll('.btn-del-term').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const li = btn.closest('li');
                        const id = li.dataset.id;
                        await fetch(`/api/model-rates/${this.currentModelSlug}/term/${id}`, { method: 'DELETE' });
                        li.remove();
                    });
                });
            };
            fillTerms('list_payment', this.data.payment, 'payment');
            fillTerms('list_additional', this.data.additional, 'additional');

            // Adders
            document.getElementById('add_incall').onclick = () => this.createRate('incall');
            document.getElementById('add_outcall').onclick = () => this.createRate('outcall');
            document.getElementById('add_extended').onclick = () => this.createRate('extended');
            document.getElementById('add_payment_term').onclick = () => this.createTerm('payment');
            document.getElementById('add_additional_term').onclick = () => this.createTerm('additional');
        },

        async createRate(rate_type){
            const s = document.getElementById(`${rate_type}_service`).value;
            const d = document.getElementById(`${rate_type}_duration`).value;
            const p = document.getElementById(`${rate_type}_price`).value;
            await fetch(`/api/model-rates/${this.currentModelSlug}/rate`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ rate_type, service_name: s, duration: d, price: p })});
            this.loadTables();
        },
        async createTerm(category){
            const t = document.getElementById(`${category}_term_text`).value;
            if (!t) return;
            await fetch(`/api/model-rates/${this.currentModelSlug}/term`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ category, term_text: t })});
            this.loadTables();
        },
        
        showLoading() {
            this.isLoading = true;
            const statusEl = document.getElementById('auto-save-status');
            const statusText = document.getElementById('save-status-text');
            
            statusText.textContent = 'Loading content...';
            statusEl.classList.remove('d-none', 'alert-success', 'alert-danger');
            statusEl.classList.add('alert-info');
        },
        
        hideLoading() {
            this.isLoading = false;
            const statusEl = document.getElementById('auto-save-status');
            statusEl.classList.add('d-none');
        },
        
        showError(message) {
            const statusEl = document.getElementById('auto-save-status');
            const statusText = document.getElementById('save-status-text');
            
            statusText.textContent = message;
            statusEl.classList.remove('d-none', 'alert-info', 'alert-success');
            statusEl.classList.add('alert-danger');
            
            setTimeout(() => {
                statusEl.classList.add('d-none');
            }, 5000);
        }
    };
    
    ratesPageEditor.init();
});
</script>