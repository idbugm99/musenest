<!-- Advanced Image Lightbox Component (Phase 8.2) -->
<div class="modal fade" id="advancedImageLightbox" tabindex="-1" role="dialog" aria-labelledby="lightboxTitle" data-bs-backdrop="static">
  <div class="modal-dialog modal-fullscreen" role="document">
    <div class="modal-content bg-dark">
      <!-- Lightbox Header -->
      <div class="modal-header bg-dark text-white border-0" id="lightboxHeader">
        <div class="d-flex align-items-center flex-grow-1">
          <h5 class="modal-title me-3" id="lightboxTitle">
            <i class="fas fa-image me-2"></i>
            <span id="lightboxImageName">Image Preview</span>
          </h5>
          
          <!-- Image Counter -->
          <div class="badge bg-primary me-3" id="lightboxCounter">
            <span id="lightboxCurrentIndex">1</span> of <span id="lightboxTotalImages">1</span>
          </div>
          
          <!-- Quick Actions -->
          <div class="btn-group me-auto">
            <button type="button" class="btn btn-outline-light btn-sm" id="lightboxAddToGallery" title="Add to Gallery">
              <i class="fas fa-plus"></i>
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="lightboxRemoveFromGallery" title="Remove from Gallery" style="display: none;">
              <i class="fas fa-trash"></i>
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="lightboxDownload" title="Download">
              <i class="fas fa-download"></i>
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="lightboxShare" title="Share">
              <i class="fas fa-share"></i>
            </button>
          </div>
        </div>
        
        <!-- View Controls -->
        <div class="d-flex align-items-center gap-2">
          <!-- Zoom Controls -->
          <div class="btn-group">
            <button type="button" class="btn btn-outline-light btn-sm" id="lightboxZoomOut" title="Zoom Out (-)">
              <i class="fas fa-search-minus"></i>
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="lightboxZoomReset" title="Fit to Screen (0)">
              <i class="fas fa-expand-arrows-alt"></i>
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="lightboxZoomIn" title="Zoom In (+)">
              <i class="fas fa-search-plus"></i>
            </button>
          </div>
          
          <!-- View Mode Toggle -->
          <div class="btn-group">
            <button type="button" class="btn btn-outline-light btn-sm" id="lightboxToggleInfo" title="Toggle Info Panel (I)">
              <i class="fas fa-info-circle"></i>
            </button>
            <button type="button" class="btn btn-outline-light btn-sm" id="lightboxToggleFullscreen" title="Toggle Fullscreen (F)">
              <i class="fas fa-expand"></i>
            </button>
          </div>
          
          <!-- Close Button -->
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal" title="Close (Escape)">
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      
      <div class="modal-body p-0 position-relative">
        <div class="row g-0 h-100">
          <!-- Main Image Area -->
          <div class="col-lg-9 col-12 position-relative" id="lightboxMainArea">
            <!-- Navigation Arrows -->
            <button type="button" class="btn btn-dark position-absolute start-0 top-50 translate-middle-y ms-3" 
                    id="lightboxPrevBtn" style="z-index: 1000;" title="Previous (←)">
              <i class="fas fa-chevron-left"></i>
            </button>
            
            <button type="button" class="btn btn-dark position-absolute end-0 top-50 translate-middle-y me-3" 
                    id="lightboxNextBtn" style="z-index: 1000;" title="Next (→)">
              <i class="fas fa-chevron-right"></i>
            </button>
            
            <!-- Image Container -->
            <div class="d-flex align-items-center justify-content-center h-100 position-relative" id="lightboxImageContainer">
              <!-- Loading State -->
              <div class="text-center text-white" id="lightboxLoading">
                <div class="spinner-border mb-3" role="status">
                  <span class="visually-hidden">Loading image...</span>
                </div>
                <p>Loading image...</p>
              </div>
              
              <!-- Main Image -->
              <div class="position-relative" id="lightboxImageWrapper" style="display: none;">
                <img id="lightboxMainImage" class="img-fluid" style="max-height: 90vh; cursor: grab;" alt="">
                
                <!-- Zoom Level Indicator -->
                <div class="position-absolute bottom-0 start-0 m-3" id="lightboxZoomLevel" style="display: none;">
                  <span class="badge bg-dark bg-opacity-75 text-white">
                    <i class="fas fa-search me-1"></i><span id="lightboxZoomPercent">100</span>%
                  </span>
                </div>
                
                <!-- Image Status Overlay -->
                <div class="position-absolute top-0 start-0 m-3" id="lightboxStatusBadges">
                  <!-- Status badges will be inserted here -->
                </div>
              </div>
              
              <!-- Error State -->
              <div class="text-center text-white" id="lightboxError" style="display: none;">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h5>Failed to Load Image</h5>
                <p class="text-muted">The image could not be loaded or does not exist.</p>
                <button type="button" class="btn btn-outline-light" id="lightboxRetryLoad">
                  <i class="fas fa-redo me-1"></i>Retry
                </button>
              </div>
            </div>
            
            <!-- Bottom Controls Bar -->
            <div class="position-absolute bottom-0 start-0 end-0 bg-dark bg-opacity-75 text-white p-3" 
                 id="lightboxBottomBar" style="backdrop-filter: blur(10px);">
              <div class="d-flex justify-content-between align-items-center">
                <!-- Slideshow Controls -->
                <div class="btn-group">
                  <button type="button" class="btn btn-outline-light btn-sm" id="lightboxPlaySlideshow" title="Play Slideshow (Space)">
                    <i class="fas fa-play"></i>
                  </button>
                  <button type="button" class="btn btn-outline-light btn-sm" id="lightboxPauseSlideshow" style="display: none;" title="Pause Slideshow (Space)">
                    <i class="fas fa-pause"></i>
                  </button>
                  <select class="form-select form-select-sm" id="lightboxSlideshowSpeed" style="width: auto;">
                    <option value="1000">Fast (1s)</option>
                    <option value="3000" selected>Normal (3s)</option>
                    <option value="5000">Slow (5s)</option>
                    <option value="10000">Very Slow (10s)</option>
                  </select>
                </div>
                
                <!-- Thumbnail Navigation -->
                <div class="d-flex align-items-center gap-2 overflow-hidden" id="lightboxThumbnails">
                  <!-- Thumbnails will be generated here -->
                </div>
                
                <!-- Batch Actions -->
                <div class="btn-group" id="lightboxBatchActions">
                  <button type="button" class="btn btn-outline-light btn-sm" id="lightboxSelectImage" title="Select for Batch Operations">
                    <i class="far fa-square"></i>
                  </button>
                  <button type="button" class="btn btn-outline-primary btn-sm" id="lightboxSelectedCount" style="display: none;">
                    <i class="fas fa-check-square me-1"></i><span>0</span> Selected
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Info Panel -->
          <div class="col-lg-3 col-12 bg-dark bg-opacity-50 border-start border-secondary" id="lightboxInfoPanel">
            <div class="p-4 h-100 overflow-auto">
              <h6 class="text-white mb-3">
                <i class="fas fa-info-circle me-2"></i>Image Details
              </h6>
              
              <!-- Basic Info -->
              <div class="card bg-dark bg-opacity-75 text-white mb-3">
                <div class="card-body p-3">
                  <div class="row g-2 small">
                    <div class="col-6"><strong>Filename:</strong></div>
                    <div class="col-6" id="lightboxInfoFilename">-</div>
                    
                    <div class="col-6"><strong>Size:</strong></div>
                    <div class="col-6" id="lightboxInfoFileSize">-</div>
                    
                    <div class="col-6"><strong>Dimensions:</strong></div>
                    <div class="col-6" id="lightboxInfoDimensions">-</div>
                    
                    <div class="col-6"><strong>Status:</strong></div>
                    <div class="col-6" id="lightboxInfoStatus">-</div>
                    
                    <div class="col-6"><strong>Context:</strong></div>
                    <div class="col-6" id="lightboxInfoContext">-</div>
                    
                    <div class="col-6"><strong>Upload Date:</strong></div>
                    <div class="col-6" id="lightboxInfoUploadDate">-</div>
                  </div>
                </div>
              </div>
              
              <!-- Quick Edit Form -->
              <div class="card bg-dark bg-opacity-75 text-white mb-3" id="lightboxEditForm">
                <div class="card-header p-2">
                  <h6 class="mb-0">
                    <i class="fas fa-edit me-1"></i>Quick Edit
                    <button type="button" class="btn btn-outline-light btn-sm float-end" id="lightboxSaveChanges" style="display: none;">
                      <i class="fas fa-save"></i>
                    </button>
                  </h6>
                </div>
                <div class="card-body p-3">
                  <div class="mb-2">
                    <label class="form-label small">Caption:</label>
                    <textarea class="form-control form-control-sm bg-dark text-white border-secondary" 
                              id="lightboxEditCaption" rows="2" placeholder="Add image caption..."></textarea>
                  </div>
                  
                  <div class="mb-2">
                    <label class="form-label small">Tags:</label>
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                           id="lightboxEditTags" placeholder="tag1, tag2, tag3...">
                  </div>
                  
                  <div class="mb-2">
                    <label class="form-label small">Alt Text:</label>
                    <input type="text" class="form-control form-control-sm bg-dark text-white border-secondary" 
                           id="lightboxEditAltText" placeholder="Describe this image for accessibility...">
                  </div>
                </div>
              </div>
              
              <!-- Gallery Sections -->
              <div class="card bg-dark bg-opacity-75 text-white mb-3" id="lightboxGallerySections">
                <div class="card-header p-2">
                  <h6 class="mb-0">
                    <i class="fas fa-layer-group me-1"></i>In Gallery Sections
                  </h6>
                </div>
                <div class="card-body p-3" id="lightboxSectionsList">
                  <div class="text-muted small">Loading sections...</div>
                </div>
              </div>
              
              <!-- EXIF Data -->
              <div class="card bg-dark bg-opacity-75 text-white" id="lightboxExifData" style="display: none;">
                <div class="card-header p-2">
                  <h6 class="mb-0">
                    <i class="fas fa-camera me-1"></i>EXIF Data
                    <button type="button" class="btn btn-outline-light btn-sm float-end" id="lightboxToggleExif">
                      <i class="fas fa-chevron-down"></i>
                    </button>
                  </h6>
                </div>
                <div class="card-body p-3" id="lightboxExifContent" style="display: none;">
                  <div class="small" id="lightboxExifDetails">
                    <!-- EXIF data will be loaded here -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Batch Operations Modal -->
<div class="modal fade" id="lightboxBatchModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="fas fa-tasks me-2"></i>Batch Operations
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Perform actions on <span id="batchSelectedCount">0</span> selected images:</p>
        
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-primary" id="batchAddToGallery">
            <i class="fas fa-plus me-1"></i>Add All to Gallery Section
          </button>
          <button type="button" class="btn btn-warning" id="batchRemoveFromGallery">
            <i class="fas fa-trash me-1"></i>Remove All from Current Section
          </button>
          <button type="button" class="btn btn-info" id="batchDownloadZip">
            <i class="fas fa-download me-1"></i>Download as ZIP
          </button>
          <button type="button" class="btn btn-secondary" id="batchClearSelection">
            <i class="fas fa-times me-1"></i>Clear Selection
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
/* Advanced Image Lightbox Styles */
.modal-fullscreen .modal-content {
  background: #000 !important;
}

/* Image interaction styles */
#lightboxMainImage {
  transition: transform 0.2s ease;
  user-select: none;
}

#lightboxMainImage.dragging {
  cursor: grabbing;
}

#lightboxMainImage.zoomed {
  cursor: move;
}

/* Navigation arrows */
#lightboxPrevBtn,
#lightboxNextBtn {
  opacity: 0.7;
  transition: opacity 0.3s ease, transform 0.2s ease;
}

#lightboxPrevBtn:hover,
#lightboxNextBtn:hover {
  opacity: 1;
  transform: scale(1.1);
}

/* Thumbnails */
.lightbox-thumbnail {
  width: 60px;
  height: 40px;
  object-fit: cover;
  cursor: pointer;
  opacity: 0.6;
  transition: all 0.2s ease;
  border: 2px solid transparent;
  border-radius: 4px;
}

.lightbox-thumbnail.active {
  opacity: 1;
  border-color: #0d6efd;
  transform: scale(1.1);
}

.lightbox-thumbnail:hover {
  opacity: 0.9;
  transform: scale(1.05);
}

/* Status badges */
.lightbox-status-badge {
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  margin-right: 4px;
  margin-bottom: 4px;
}

.status-approved { background: rgba(25, 135, 84, 0.9); }
.status-approved_blurred { background: rgba(13, 110, 253, 0.9); }
.status-pending { background: rgba(255, 193, 7, 0.9); color: #000; }
.status-flagged { background: rgba(220, 53, 69, 0.9); }

.context-public_site { background: rgba(32, 201, 151, 0.9); }
.context-paysite { background: rgba(111, 66, 193, 0.9); }
.context-private { background: rgba(108, 117, 125, 0.9); }

/* Info panel animations */
#lightboxInfoPanel {
  transform: translateX(0);
  transition: transform 0.3s ease;
}

#lightboxInfoPanel.hidden {
  transform: translateX(100%);
}

/* Slideshow mode */
.slideshow-active #lightboxHeader,
.slideshow-active #lightboxBottomBar {
  opacity: 0;
  transition: opacity 0.3s ease;
}

.slideshow-active #lightboxHeader:hover,
.slideshow-active #lightboxBottomBar:hover {
  opacity: 1;
}

/* Zoom effects */
.zoom-transition {
  transition: transform 0.3s ease !important;
}

/* Loading states */
.lightbox-loading {
  opacity: 0.5;
  pointer-events: none;
}

/* Responsive design */
@media (max-width: 768px) {
  #lightboxInfoPanel {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 100%;
    z-index: 1001;
    transform: translateX(100%);
  }
  
  #lightboxInfoPanel.visible {
    transform: translateX(0);
  }
  
  .lightbox-thumbnail {
    width: 50px;
    height: 35px;
  }
  
  #lightboxThumbnails {
    max-width: 200px;
  }
}

/* Keyboard focus styles */
.btn:focus,
.lightbox-thumbnail:focus {
  outline: 2px solid #0d6efd;
  outline-offset: 2px;
}

/* High contrast mode */
@media (prefers-contrast: high) {
  .card {
    border: 2px solid ButtonText !important;
  }
  
  .btn-outline-light {
    border-color: ButtonText !important;
    color: ButtonText !important;
  }
}

/* Reduced motion */
@media (prefers-reduced-motion: reduce) {
  #lightboxMainImage,
  .lightbox-thumbnail,
  #lightboxInfoPanel {
    transition: none !important;
  }
}

/* Print styles */
@media print {
  .modal {
    display: none !important;
  }
}
</style>

<script>
// Advanced Image Lightbox Component
class AdvancedImageLightbox {
  constructor() {
    this.modal = null;
    this.images = [];
    this.currentIndex = 0;
    this.currentSlug = null;
    
    // State management
    this.selectedImages = new Set();
    this.isInfoPanelVisible = true;
    this.isFullscreen = false;
    this.isSlideshowActive = false;
    this.slideshowInterval = null;
    this.slideshowSpeed = 3000;
    
    // Zoom and pan state
    this.zoomLevel = 1;
    this.maxZoom = 5;
    this.minZoom = 0.1;
    this.panX = 0;
    this.panY = 0;
    this.isDragging = false;
    
    // Mobile-specific state
    this.isMobileDevice = MobileTouchHandler.isSupported();
    this.mobileGestures = {
      pinchStart: null,
      initialZoom: 1,
      initialPan: { x: 0, y: 0 }
    };
    this.lastMouseX = 0;
    this.lastMouseY = 0;
    
    // Performance
    this.imageCache = new Map();
    this.preloadRadius = 2; // Preload 2 images before and after current
    
    this.initializeElements();
    this.bindEvents();
  }

  initializeElements() {
    this.modal = new bootstrap.Modal(document.getElementById('advancedImageLightbox'), {
      backdrop: 'static',
      keyboard: false
    });
    
    this.batchModal = new bootstrap.Modal(document.getElementById('lightboxBatchModal'));
    
    // Get DOM references
    this.elements = {
      // Header elements
      imageName: document.getElementById('lightboxImageName'),
      counter: document.getElementById('lightboxCounter'),
      currentIndex: document.getElementById('lightboxCurrentIndex'),
      totalImages: document.getElementById('lightboxTotalImages'),
      
      // Navigation
      prevBtn: document.getElementById('lightboxPrevBtn'),
      nextBtn: document.getElementById('lightboxNextBtn'),
      
      // Main image
      loading: document.getElementById('lightboxLoading'),
      imageWrapper: document.getElementById('lightboxImageWrapper'),
      mainImage: document.getElementById('lightboxMainImage'),
      error: document.getElementById('lightboxError'),
      retryBtn: document.getElementById('lightboxRetryLoad'),
      
      // Controls
      zoomIn: document.getElementById('lightboxZoomIn'),
      zoomOut: document.getElementById('lightboxZoomOut'),
      zoomReset: document.getElementById('lightboxZoomReset'),
      zoomLevel: document.getElementById('lightboxZoomLevel'),
      zoomPercent: document.getElementById('lightboxZoomPercent'),
      
      toggleInfo: document.getElementById('lightboxToggleInfo'),
      toggleFullscreen: document.getElementById('lightboxToggleFullscreen'),
      infoPanel: document.getElementById('lightboxInfoPanel'),
      
      // Actions
      addToGallery: document.getElementById('lightboxAddToGallery'),
      removeFromGallery: document.getElementById('lightboxRemoveFromGallery'),
      download: document.getElementById('lightboxDownload'),
      share: document.getElementById('lightboxShare'),
      
      // Slideshow
      playSlideshow: document.getElementById('lightboxPlaySlideshow'),
      pauseSlideshow: document.getElementById('lightboxPauseSlideshow'),
      slideshowSpeed: document.getElementById('lightboxSlideshowSpeed'),
      
      // Info panel
      infoFilename: document.getElementById('lightboxInfoFilename'),
      infoFileSize: document.getElementById('lightboxInfoFileSize'),
      infoDimensions: document.getElementById('lightboxInfoDimensions'),
      infoStatus: document.getElementById('lightboxInfoStatus'),
      infoContext: document.getElementById('lightboxInfoContext'),
      infoUploadDate: document.getElementById('lightboxInfoUploadDate'),
      
      // Quick edit
      editCaption: document.getElementById('lightboxEditCaption'),
      editTags: document.getElementById('lightboxEditTags'),
      editAltText: document.getElementById('lightboxEditAltText'),
      saveChanges: document.getElementById('lightboxSaveChanges'),
      
      // Gallery sections
      sectionsList: document.getElementById('lightboxSectionsList'),
      
      // Thumbnails and batch
      thumbnails: document.getElementById('lightboxThumbnails'),
      selectImage: document.getElementById('lightboxSelectImage'),
      selectedCount: document.getElementById('lightboxSelectedCount'),
      
      // Status badges
      statusBadges: document.getElementById('lightboxStatusBadges')
    };
  }

  bindEvents() {
    // Navigation
    this.elements.prevBtn.addEventListener('click', () => this.previousImage());
    this.elements.nextBtn.addEventListener('click', () => this.nextImage());
    
    // Zoom controls
    this.elements.zoomIn.addEventListener('click', () => this.zoomIn());
    this.elements.zoomOut.addEventListener('click', () => this.zoomOut());
    this.elements.zoomReset.addEventListener('click', () => this.resetZoom());
    
    // Toggle controls
    this.elements.toggleInfo.addEventListener('click', () => this.toggleInfoPanel());
    this.elements.toggleFullscreen.addEventListener('click', () => this.toggleFullscreen());
    
    // Actions
    this.elements.addToGallery.addEventListener('click', () => this.addToGallery());
    this.elements.removeFromGallery.addEventListener('click', () => this.removeFromGallery());
    this.elements.download.addEventListener('click', () => this.downloadImage());
    this.elements.share.addEventListener('click', () => this.shareImage());
    
    // Slideshow
    this.elements.playSlideshow.addEventListener('click', () => this.startSlideshow());
    this.elements.pauseSlideshow.addEventListener('click', () => this.stopSlideshow());
    this.elements.slideshowSpeed.addEventListener('change', (e) => {
      this.slideshowSpeed = parseInt(e.target.value);
      if (this.isSlideshowActive) {
        this.restartSlideshow();
      }
    });
    
    // Selection
    this.elements.selectImage.addEventListener('click', () => this.toggleImageSelection());
    this.elements.selectedCount.addEventListener('click', () => this.showBatchModal());
    
    // Quick edit
    this.elements.editCaption.addEventListener('input', () => this.showSaveButton());
    this.elements.editTags.addEventListener('input', () => this.showSaveButton());
    this.elements.editAltText.addEventListener('input', () => this.showSaveButton());
    this.elements.saveChanges.addEventListener('click', () => this.saveImageChanges());
    
    // Retry button
    this.elements.retryBtn.addEventListener('click', () => this.loadCurrentImage());
    
    // Mouse events for zoom and pan
    this.elements.mainImage.addEventListener('mousedown', (e) => this.startPan(e));
    this.elements.mainImage.addEventListener('mousemove', (e) => this.handlePan(e));
    this.elements.mainImage.addEventListener('mouseup', () => this.stopPan());
    this.elements.mainImage.addEventListener('wheel', (e) => this.handleWheel(e));
    
    // Double click to zoom
    this.elements.mainImage.addEventListener('dblclick', (e) => this.handleDoubleClick(e));
    
    // Keyboard events
    document.addEventListener('keydown', (e) => {
      if (this.modal._isShown) {
        this.handleKeyboardShortcuts(e);
      }
    });

    // Mobile touch event listeners
    if (this.isMobileDevice) {
      this.bindMobileTouchEvents();
    }
    
    // Image load events
    this.elements.mainImage.addEventListener('load', () => this.onImageLoad());
    this.elements.mainImage.addEventListener('error', () => this.onImageError());
    
    // Modal events
    document.getElementById('advancedImageLightbox').addEventListener('hidden.bs.modal', () => {
      this.onModalClose();
    });
    
    // Batch modal events
    document.getElementById('batchAddToGallery').addEventListener('click', () => this.batchAddToGallery());
    document.getElementById('batchRemoveFromGallery').addEventListener('click', () => this.batchRemoveFromGallery());
    document.getElementById('batchDownloadZip').addEventListener('click', () => this.batchDownloadZip());
    document.getElementById('batchClearSelection').addEventListener('click', () => this.clearSelection());
  }

  // Public API
  open(options = {}) {
    const { images, currentIndex = 0, slug, sectionId } = options;
    
    if (!images || !Array.isArray(images) || images.length === 0) {
      console.error('AdvancedImageLightbox: images array is required');
      return;
    }
    
    this.images = images;
    this.currentIndex = Math.max(0, Math.min(currentIndex, images.length - 1));
    this.currentSlug = slug;
    this.currentSectionId = sectionId;
    
    // Reset state
    this.selectedImages.clear();
    this.resetZoom();
    this.stopSlideshow();
    
    this.updateCounter();
    this.loadCurrentImage();
    this.generateThumbnails();
    this.preloadImages();
    
    this.modal.show();
    
    // Load gallery sections if slug is provided
    if (this.currentSlug) {
      this.loadGallerySections();
    }
  }

  loadCurrentImage() {
    if (!this.images[this.currentIndex]) return;
    
    const image = this.images[this.currentIndex];
    
    this.showLoading();
    this.elements.imageName.textContent = image.filename || 'Unknown';
    
    // Check cache first
    const imageUrl = this.getImageUrl(image);
    const cachedImage = this.imageCache.get(imageUrl);
    
    if (cachedImage && cachedImage.complete) {
      this.displayImage(cachedImage, image);
      return;
    }
    
    // Load new image
    const img = new Image();
    img.onload = () => {
      this.imageCache.set(imageUrl, img);
      this.displayImage(img, image);
    };
    img.onerror = () => {
      this.onImageError();
    };
    img.src = imageUrl;
  }

  displayImage(imgElement, imageData) {
    this.hideLoading();
    this.hideError();
    
    // Set image source
    this.elements.mainImage.src = imgElement.src;
    this.elements.mainImage.style.display = 'block';
    this.elements.imageWrapper.style.display = 'block';
    
    // Update image info
    this.updateImageInfo(imageData);
    this.updateStatusBadges(imageData);
    this.updateActionButtons(imageData);
    this.resetZoom();
    
    // Update selection state
    this.updateSelectionButton(imageData);
  }

  updateImageInfo(image) {
    this.elements.infoFilename.textContent = image.filename || 'Unknown';
    this.elements.infoFileSize.textContent = this.formatFileSize(image.size || 0);
    this.elements.infoDimensions.textContent = image.width && image.height 
      ? `${image.width} × ${image.height}` : 'Unknown';
    this.elements.infoStatus.textContent = image.moderation_status || 'Unknown';
    this.elements.infoContext.textContent = image.usage_intent || 'Unknown';
    this.elements.infoUploadDate.textContent = image.created_at 
      ? new Date(image.created_at).toLocaleDateString() : 'Unknown';
    
    // Load existing metadata
    this.elements.editCaption.value = image.caption || '';
    this.elements.editTags.value = image.tags || '';
    this.elements.editAltText.value = image.alt_text || '';
    
    this.hideSaveButton();
  }

  updateStatusBadges(image) {
    let badgesHTML = '';
    
    if (image.moderation_status) {
      badgesHTML += `<span class="lightbox-status-badge status-${image.moderation_status}">${image.moderation_status}</span>`;
    }
    
    if (image.usage_intent && image.usage_intent !== 'public_site') {
      badgesHTML += `<span class="lightbox-status-badge context-${image.usage_intent}">${image.usage_intent}</span>`;
    }
    
    if (image.in_section) {
      badgesHTML += `<span class="lightbox-status-badge" style="background: rgba(40, 167, 69, 0.9);">In Gallery</span>`;
    }
    
    this.elements.statusBadges.innerHTML = badgesHTML;
  }

  updateActionButtons(image) {
    if (image.in_section) {
      this.elements.addToGallery.style.display = 'none';
      this.elements.removeFromGallery.style.display = 'inline-block';
    } else {
      this.elements.addToGallery.style.display = 'inline-block';
      this.elements.removeFromGallery.style.display = 'none';
    }
  }

  // Navigation methods
  previousImage() {
    if (this.currentIndex > 0) {
      this.currentIndex--;
      this.updateCounter();
      this.loadCurrentImage();
      this.updateThumbnailSelection();
      this.preloadImages();
    }
  }

  nextImage() {
    if (this.currentIndex < this.images.length - 1) {
      this.currentIndex++;
      this.updateCounter();
      this.loadCurrentImage();
      this.updateThumbnailSelection();
      this.preloadImages();
    }
  }

  jumpToImage(index) {
    if (index >= 0 && index < this.images.length) {
      this.currentIndex = index;
      this.updateCounter();
      this.loadCurrentImage();
      this.updateThumbnailSelection();
      this.preloadImages();
    }
  }

  updateCounter() {
    this.elements.currentIndex.textContent = this.currentIndex + 1;
    this.elements.totalImages.textContent = this.images.length;
    
    // Update navigation button states
    this.elements.prevBtn.disabled = this.currentIndex === 0;
    this.elements.nextBtn.disabled = this.currentIndex === this.images.length - 1;
  }

  // Zoom and pan methods
  zoomIn(factor = 1.5) {
    this.setZoom(this.zoomLevel * factor);
  }

  zoomOut(factor = 1.5) {
    this.setZoom(this.zoomLevel / factor);
  }

  setZoom(newZoom) {
    this.zoomLevel = Math.max(this.minZoom, Math.min(this.maxZoom, newZoom));
    this.applyTransform();
    this.updateZoomUI();
  }

  resetZoom() {
    this.zoomLevel = 1;
    this.panX = 0;
    this.panY = 0;
    this.applyTransform();
    this.updateZoomUI();
  }

  applyTransform() {
    const transform = `translate(${this.panX}px, ${this.panY}px) scale(${this.zoomLevel})`;
    this.elements.mainImage.style.transform = transform;
    
    // Update cursor based on zoom level
    if (this.zoomLevel > 1) {
      this.elements.mainImage.style.cursor = 'move';
      this.elements.mainImage.classList.add('zoomed');
    } else {
      this.elements.mainImage.style.cursor = 'grab';
      this.elements.mainImage.classList.remove('zoomed');
    }
  }

  updateZoomUI() {
    const percentage = Math.round(this.zoomLevel * 100);
    this.elements.zoomPercent.textContent = percentage;
    
    if (this.zoomLevel !== 1) {
      this.elements.zoomLevel.style.display = 'block';
    } else {
      this.elements.zoomLevel.style.display = 'none';
    }
  }

  startPan(e) {
    if (this.zoomLevel > 1) {
      this.isDragging = true;
      this.lastMouseX = e.clientX;
      this.lastMouseY = e.clientY;
      this.elements.mainImage.classList.add('dragging');
      e.preventDefault();
    }
  }

  handlePan(e) {
    if (this.isDragging) {
      const deltaX = e.clientX - this.lastMouseX;
      const deltaY = e.clientY - this.lastMouseY;
      
      this.panX += deltaX;
      this.panY += deltaY;
      
      this.lastMouseX = e.clientX;
      this.lastMouseY = e.clientY;
      
      this.applyTransform();
    }
  }

  stopPan() {
    this.isDragging = false;
    this.elements.mainImage.classList.remove('dragging');
  }

  handleWheel(e) {
    e.preventDefault();
    
    const rect = this.elements.mainImage.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    
    const zoom = e.deltaY < 0 ? 1.2 : 0.8;
    const newZoom = this.zoomLevel * zoom;
    
    if (newZoom >= this.minZoom && newZoom <= this.maxZoom) {
      // Zoom towards mouse position
      this.panX = x - (x - this.panX) * zoom;
      this.panY = y - (y - this.panY) * zoom;
      this.zoomLevel = newZoom;
      
      this.applyTransform();
      this.updateZoomUI();
    }
  }

  handleDoubleClick(e) {
    if (this.zoomLevel === 1) {
      // Zoom to 2x at click position
      const rect = this.elements.mainImage.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      this.panX = x - (x - this.panX) * 2;
      this.panY = y - (y - this.panY) * 2;
      this.zoomLevel = 2;
    } else {
      // Reset zoom
      this.resetZoom();
    }
    
    this.elements.mainImage.classList.add('zoom-transition');
    this.applyTransform();
    this.updateZoomUI();
    
    setTimeout(() => {
      this.elements.mainImage.classList.remove('zoom-transition');
    }, 300);
  }

  // Slideshow methods
  startSlideshow() {
    this.isSlideshowActive = true;
    this.elements.playSlideshow.style.display = 'none';
    this.elements.pauseSlideshow.style.display = 'inline-block';
    
    document.body.classList.add('slideshow-active');
    
    this.slideshowInterval = setInterval(() => {
      if (this.currentIndex < this.images.length - 1) {
        this.nextImage();
      } else {
        // Loop back to beginning
        this.jumpToImage(0);
      }
    }, this.slideshowSpeed);
  }

  stopSlideshow() {
    this.isSlideshowActive = false;
    this.elements.playSlideshow.style.display = 'inline-block';
    this.elements.pauseSlideshow.style.display = 'none';
    
    document.body.classList.remove('slideshow-active');
    
    if (this.slideshowInterval) {
      clearInterval(this.slideshowInterval);
      this.slideshowInterval = null;
    }
  }

  restartSlideshow() {
    if (this.isSlideshowActive) {
      this.stopSlideshow();
      this.startSlideshow();
    }
  }

  // Thumbnail methods
  generateThumbnails() {
    const maxThumbnails = 10;
    const start = Math.max(0, this.currentIndex - Math.floor(maxThumbnails / 2));
    const end = Math.min(this.images.length, start + maxThumbnails);
    
    let thumbnailsHTML = '';
    
    for (let i = start; i < end; i++) {
      const image = this.images[i];
      const isActive = i === this.currentIndex;
      
      thumbnailsHTML += `
        <img src="${this.getImageUrl(image)}"
             class="lightbox-thumbnail ${isActive ? 'active' : ''}"
             data-index="${i}"
             alt="${image.filename}"
             loading="lazy">
      `;
    }
    
    this.elements.thumbnails.innerHTML = thumbnailsHTML;
    
    // Bind thumbnail clicks
    this.elements.thumbnails.querySelectorAll('.lightbox-thumbnail').forEach(thumb => {
      thumb.addEventListener('click', () => {
        const index = parseInt(thumb.dataset.index);
        this.jumpToImage(index);
      });
    });
  }

  updateThumbnailSelection() {
    this.elements.thumbnails.querySelectorAll('.lightbox-thumbnail').forEach(thumb => {
      const index = parseInt(thumb.dataset.index);
      thumb.classList.toggle('active', index === this.currentIndex);
    });
  }

  // Selection and batch operations
  toggleImageSelection() {
    const currentImage = this.images[this.currentIndex];
    if (!currentImage) return;
    
    const filename = currentImage.filename;
    
    if (this.selectedImages.has(filename)) {
      this.selectedImages.delete(filename);
    } else {
      this.selectedImages.add(filename);
    }
    
    this.updateSelectionButton(currentImage);
    this.updateSelectionCounter();
  }

  updateSelectionButton(image) {
    const isSelected = this.selectedImages.has(image.filename);
    
    if (isSelected) {
      this.elements.selectImage.innerHTML = '<i class="fas fa-check-square"></i>';
      this.elements.selectImage.classList.add('btn-primary');
      this.elements.selectImage.classList.remove('btn-outline-light');
    } else {
      this.elements.selectImage.innerHTML = '<i class="far fa-square"></i>';
      this.elements.selectImage.classList.remove('btn-primary');
      this.elements.selectImage.classList.add('btn-outline-light');
    }
  }

  updateSelectionCounter() {
    const count = this.selectedImages.size;
    
    if (count > 0) {
      this.elements.selectedCount.style.display = 'inline-block';
      this.elements.selectedCount.querySelector('span').textContent = count;
    } else {
      this.elements.selectedCount.style.display = 'none';
    }
  }

  showBatchModal() {
    document.getElementById('batchSelectedCount').textContent = this.selectedImages.size;
    this.batchModal.show();
  }

  clearSelection() {
    this.selectedImages.clear();
    this.updateSelectionButton(this.images[this.currentIndex]);
    this.updateSelectionCounter();
    this.batchModal.hide();
  }

  // Image actions
  async addToGallery() {
    if (!this.currentSlug || !this.currentSectionId) {
      alert('Gallery section not specified');
      return;
    }
    
    const currentImage = this.images[this.currentIndex];
    
    try {
      const response = await fetch(`/api/model-gallery/${this.currentSlug}/sections/${this.currentSectionId}/images/batch`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          filenames: [currentImage.filename]
        })
      });
      
      const result = await response.json();
      
      if (result.success && result.data.summary.added > 0) {
        // Update image state
        currentImage.in_section = true;
        this.updateActionButtons(currentImage);
        this.updateStatusBadges(currentImage);
        
        this.showToast('success', 'Image added to gallery successfully!');
      } else {
        throw new Error(result.message || 'Failed to add image');
      }
      
    } catch (error) {
      console.error('Error adding image to gallery:', error);
      this.showToast('error', 'Failed to add image to gallery');
    }
  }

  async removeFromGallery() {
    if (!this.currentSlug || !this.currentSectionId) {
      alert('Gallery section not specified');
      return;
    }
    
    const currentImage = this.images[this.currentIndex];
    
    if (!confirm(`Remove "${currentImage.filename}" from gallery?`)) {
      return;
    }
    
    try {
      const response = await fetch(`/api/model-gallery/${this.currentSlug}/sections/${this.currentSectionId}/images/batch`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          filenames: [currentImage.filename]
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        // Update image state
        currentImage.in_section = false;
        this.updateActionButtons(currentImage);
        this.updateStatusBadges(currentImage);
        
        this.showToast('success', 'Image removed from gallery successfully!');
      } else {
        throw new Error(result.message || 'Failed to remove image');
      }
      
    } catch (error) {
      console.error('Error removing image from gallery:', error);
      this.showToast('error', 'Failed to remove image from gallery');
    }
  }

  downloadImage() {
    const currentImage = this.images[this.currentIndex];
    const link = document.createElement('a');
    link.href = this.getImageUrl(currentImage);
    link.download = currentImage.filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  shareImage() {
    const currentImage = this.images[this.currentIndex];
    const imageUrl = window.location.origin + this.getImageUrl(currentImage);
    
    if (navigator.share) {
      navigator.share({
        title: currentImage.filename,
        url: imageUrl
      }).catch(console.error);
    } else {
      // Fallback: copy URL to clipboard
      navigator.clipboard.writeText(imageUrl).then(() => {
        this.showToast('success', 'Image URL copied to clipboard!');
      }).catch(() => {
        // Fallback: show URL in prompt
        prompt('Copy this URL to share the image:', imageUrl);
      });
    }
  }

  // Quick edit methods
  showSaveButton() {
    this.elements.saveChanges.style.display = 'inline-block';
  }

  hideSaveButton() {
    this.elements.saveChanges.style.display = 'none';
  }

  async saveImageChanges() {
    const currentImage = this.images[this.currentIndex];
    const caption = this.elements.editCaption.value.trim();
    const tags = this.elements.editTags.value.trim();
    const altText = this.elements.editAltText.value.trim();
    
    try {
      // This would typically call an API to update image metadata
      // For now, we'll just update the local data
      currentImage.caption = caption;
      currentImage.tags = tags;
      currentImage.alt_text = altText;
      
      this.hideSaveButton();
      this.showToast('success', 'Changes saved successfully!');
      
      // TODO: Implement actual API call to save metadata
      console.log('Saving image metadata:', { caption, tags, altText });
      
    } catch (error) {
      console.error('Error saving image changes:', error);
      this.showToast('error', 'Failed to save changes');
    }
  }

  // Gallery sections
  async loadGallerySections() {
    try {
      const response = await fetch(`/api/model-gallery/${this.currentSlug}/sections`);
      const result = await response.json();
      
      if (result.success) {
        const sections = result.data.sections || [];
        this.renderGallerySections(sections);
      } else {
        throw new Error(result.message || 'Failed to load sections');
      }
      
    } catch (error) {
      console.error('Error loading gallery sections:', error);
      this.elements.sectionsList.innerHTML = '<div class="text-muted small">Failed to load sections</div>';
    }
  }

  renderGallerySections(sections) {
    if (sections.length === 0) {
      this.elements.sectionsList.innerHTML = '<div class="text-muted small">No gallery sections found</div>';
      return;
    }
    
    const currentImage = this.images[this.currentIndex];
    
    this.elements.sectionsList.innerHTML = sections.map(section => `
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
          <div class="small fw-bold">${section.title}</div>
          <div class="text-muted" style="font-size: 11px;">
            ${section.is_visible ? 'Public' : 'Private'} • ${section.image_count || 0} images
          </div>
        </div>
        <button type="button" class="btn btn-outline-light btn-sm" 
                onclick="lightboxAddToSection(${section.id}, '${section.title}')">
          <i class="fas fa-plus"></i>
        </button>
      </div>
    `).join('');
  }

  // UI state methods
  toggleInfoPanel() {
    this.isInfoPanelVisible = !this.isInfoPanelVisible;
    
    if (this.isInfoPanelVisible) {
      this.elements.infoPanel.classList.remove('hidden');
      this.elements.toggleInfo.innerHTML = '<i class="fas fa-info-circle"></i>';
    } else {
      this.elements.infoPanel.classList.add('hidden');
      this.elements.toggleInfo.innerHTML = '<i class="far fa-info-circle"></i>';
    }
  }

  toggleFullscreen() {
    if (!this.isFullscreen) {
      document.documentElement.requestFullscreen?.();
      this.elements.toggleFullscreen.innerHTML = '<i class="fas fa-compress"></i>';
      this.isFullscreen = true;
    } else {
      document.exitFullscreen?.();
      this.elements.toggleFullscreen.innerHTML = '<i class="fas fa-expand"></i>';
      this.isFullscreen = false;
    }
  }

  // Keyboard shortcuts
  handleKeyboardShortcuts(e) {
    // Prevent shortcuts when typing in inputs
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
      return;
    }
    
    switch (e.key) {
      case 'ArrowLeft':
      case 'h':
        e.preventDefault();
        this.previousImage();
        break;
        
      case 'ArrowRight':
      case 'l':
        e.preventDefault();
        this.nextImage();
        break;
        
      case '=':
      case '+':
        e.preventDefault();
        this.zoomIn();
        break;
        
      case '-':
      case '_':
        e.preventDefault();
        this.zoomOut();
        break;
        
      case '0':
        e.preventDefault();
        this.resetZoom();
        break;
        
      case 'f':
      case 'F':
        e.preventDefault();
        this.toggleFullscreen();
        break;
        
      case 'i':
      case 'I':
        e.preventDefault();
        this.toggleInfoPanel();
        break;
        
      case ' ':
        e.preventDefault();
        if (this.isSlideshowActive) {
          this.stopSlideshow();
        } else {
          this.startSlideshow();
        }
        break;
        
      case 's':
      case 'S':
        e.preventDefault();
        this.toggleImageSelection();
        break;
        
      case 'd':
      case 'D':
        e.preventDefault();
        this.downloadImage();
        break;
        
      case 'Escape':
        e.preventDefault();
        if (this.isFullscreen) {
          this.toggleFullscreen();
        } else {
          this.modal.hide();
        }
        break;
    }
  }

  // Utility methods
  getImageUrl(image) {
    if (!this.currentSlug) return '';
    return `/uploads/${encodeURIComponent(this.currentSlug)}/public/gallery/${encodeURIComponent(image.filename)}`;
  }

  formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
  }

  showToast(type, message) {
    // Simple toast implementation - could be enhanced with a proper toast library
    console.log(`${type.toUpperCase()}: ${message}`);
    
    // For now, just use a simple alert
    if (type === 'error') {
      alert(`Error: ${message}`);
    }
  }

  preloadImages() {
    const start = Math.max(0, this.currentIndex - this.preloadRadius);
    const end = Math.min(this.images.length, this.currentIndex + this.preloadRadius + 1);
    
    for (let i = start; i < end; i++) {
      if (i !== this.currentIndex) {
        const imageUrl = this.getImageUrl(this.images[i]);
        
        if (!this.imageCache.has(imageUrl)) {
          const img = new Image();
          img.onload = () => {
            this.imageCache.set(imageUrl, img);
          };
          img.src = imageUrl;
        }
      }
    }
  }

  // Event handlers
  showLoading() {
    this.elements.loading.style.display = 'block';
    this.elements.imageWrapper.style.display = 'none';
    this.elements.error.style.display = 'none';
  }

  hideLoading() {
    this.elements.loading.style.display = 'none';
  }

  showError() {
    this.elements.loading.style.display = 'none';
    this.elements.imageWrapper.style.display = 'none';
    this.elements.error.style.display = 'block';
  }

  hideError() {
    this.elements.error.style.display = 'none';
  }

  onImageLoad() {
    // Image loaded successfully
  }

  onImageError() {
    this.showError();
  }

  onModalClose() {
    this.stopSlideshow();
    this.resetZoom();
    
    // Clear cache if it gets too large
    if (this.imageCache.size > 50) {
      this.imageCache.clear();
    }
  }

  // Batch operations
  async batchAddToGallery() {
    if (!this.currentSlug || !this.currentSectionId) {
      alert('Gallery section not specified');
      return;
    }
    
    const filenames = Array.from(this.selectedImages);
    
    try {
      const response = await fetch(`/api/model-gallery/${this.currentSlug}/sections/${this.currentSectionId}/images/batch`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ filenames })
      });
      
      const result = await response.json();
      
      if (result.success) {
        const summary = result.data.summary;
        this.showToast('success', `Added ${summary.added} images to gallery! ${summary.skipped} were already in gallery.`);
        
        // Update image states
        this.images.forEach(image => {
          if (filenames.includes(image.filename)) {
            const resultItem = result.data.results.find(r => r.filename === image.filename);
            if (resultItem && resultItem.status === 'added') {
              image.in_section = true;
            }
          }
        });
        
        // Refresh current image display
        this.updateActionButtons(this.images[this.currentIndex]);
        this.updateStatusBadges(this.images[this.currentIndex]);
        
        this.clearSelection();
      } else {
        throw new Error(result.message || 'Failed to add images');
      }
      
    } catch (error) {
      console.error('Error in batch add to gallery:', error);
      this.showToast('error', 'Failed to add images to gallery');
    }
  }

  async batchRemoveFromGallery() {
    if (!this.currentSlug || !this.currentSectionId) {
      alert('Gallery section not specified');
      return;
    }
    
    const filenames = Array.from(this.selectedImages);
    
    if (!confirm(`Remove ${filenames.length} images from gallery?`)) {
      return;
    }
    
    try {
      const response = await fetch(`/api/model-gallery/${this.currentSlug}/sections/${this.currentSectionId}/images/batch`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ filenames })
      });
      
      const result = await response.json();
      
      if (result.success) {
        this.showToast('success', `Removed ${result.data.removed} images from gallery successfully!`);
        
        // Update image states
        this.images.forEach(image => {
          if (filenames.includes(image.filename)) {
            image.in_section = false;
          }
        });
        
        // Refresh current image display
        this.updateActionButtons(this.images[this.currentIndex]);
        this.updateStatusBadges(this.images[this.currentIndex]);
        
        this.clearSelection();
      } else {
        throw new Error(result.message || 'Failed to remove images');
      }
      
    } catch (error) {
      console.error('Error in batch remove from gallery:', error);
      this.showToast('error', 'Failed to remove images from gallery');
    }
  }

  batchDownloadZip() {
    // This would typically generate and download a ZIP file
    this.showToast('info', 'ZIP download feature coming soon!');
    
    // TODO: Implement ZIP download functionality
    console.log('Batch download requested for:', Array.from(this.selectedImages));
  }
}

// Initialize the advanced image lightbox when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  window.advancedImageLightbox = new AdvancedImageLightbox();
});

// Utility function for other components to use
window.openAdvancedImageLightbox = function(options) {
  if (window.advancedImageLightbox) {
    window.advancedImageLightbox.open(options);
  } else {
    console.error('AdvancedImageLightbox not initialized');
  }
};

// Helper function for adding to specific sections from lightbox
window.lightboxAddToSection = async function(sectionId, sectionTitle) {
  const lightbox = window.advancedImageLightbox;
  if (!lightbox) return;
  
  const currentImage = lightbox.images[lightbox.currentIndex];
  
  try {
    const response = await fetch(`/api/model-gallery/${lightbox.currentSlug}/sections/${sectionId}/images/batch`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        filenames: [currentImage.filename]
      })
    });
    
    const result = await response.json();
    
    if (result.success && result.data.summary.added > 0) {
      lightbox.showToast('success', `Image added to "${sectionTitle}" successfully!`);
      lightbox.loadGallerySections(); // Refresh sections list
    } else {
      lightbox.showToast('error', result.message || `Failed to add image to "${sectionTitle}"`);
    }
    
  } catch (error) {
    console.error('Error adding image to section:', error);
    lightbox.showToast('error', `Failed to add image to "${sectionTitle}"`);
  }
};
</script>